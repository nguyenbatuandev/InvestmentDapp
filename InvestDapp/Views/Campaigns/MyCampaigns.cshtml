@model IEnumerable<InvestDapp.Models.Campaign>
@{
    ViewData["Title"] = "Chiến Dịch Của Tôi";
    Layout = "~/Pages/_Layout.cshtml";
}

@section Styles {
<style>
/* ===== BÁM CSS TỪ LAYOUT, KHÔNG DÙNG :root ===== */

/* khung trang */
.mc-wrap{max-width:1200px;margin:calc(var(--header-h,72px) + 32px) auto 64px;padding:0 16px;color:var(--fg)}

/* hero */
.mc-hero{
    background:var(--glass);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:24px 22px;
    margin-bottom:18px
}
.mc-hero h1{margin:0 0 6px;font-weight:800;letter-spacing:.2px;font-size:1.9rem}
.mc-hero p{margin:0;color:var(--muted)}

/* quick actions */
.mc-qacts{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin:14px 0 26px}
.mc-qbtn{
    display:flex;align-items:center;gap:10px;
    padding:10px 12px;border:1px solid var(--border);
    border-radius:12px;background:var(--glass);color:var(--fg);text-decoration:none;
    box-shadow:var(--shadow);transition:transform .16s, box-shadow .16s, border-color .16s
}
.mc-qbtn:hover{transform:translateY(-2px);border-color:color-mix(in oklab,var(--primary) 60%, transparent)}
.mc-qbtn i{opacity:.9}

/* lưới card */
.mc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px}

/* card (đồng cao) */
.mc-card{
    display:flex;flex-direction:column;min-height:380px;
    background:var(--glass);border:1px solid var(--border);border-radius:var(--radius);
    box-shadow:var(--shadow);overflow:hidden
}
.mc-ch{position:relative;padding:18px 18px 12px;border-bottom:1px solid var(--border)}
.mc-title{font-weight:700;margin:0 0 6px;line-height:1.35}
.mc-title a{color:var(--fg);text-decoration:none}
.mc-title a:hover{color:var(--primary)}
.mc-desc{color:var(--muted);font-size:.95rem;line-height:1.6;margin:0 0 8px}

.mc-badge{
    position:absolute;top:14px;right:14px;padding:6px 10px;border-radius:999px;
    font-weight:800;font-size:.74rem;letter-spacing:.3px;display:inline-flex;align-items:center;gap:6px;
    border:1px solid var(--border);background:var(--card)
}
.badge-pending{color:#ffb800;border-color:color-mix(in oklab,#ffb800 40%, var(--border))}
.badge-approved{color:#00d4aa;border-color:color-mix(in oklab,#00d4aa 40%, var(--border))}
.badge-rejected{color:#ff6b6b;border-color:color-mix(in oklab,#ff6b6b 40%, var(--border))}

/* body linh hoạt để đồng cao */
.mc-cb{display:flex;flex-direction:column;gap:14px;padding:14px 16px;flex:1}

/* stats */
.mc-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.mc-stat{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;text-align:center}
.mc-stat .v{font-weight:800}
.mc-stat .l{color:var(--muted);font-size:.8rem}

/* tiến độ */
.mc-prog .hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.mc-prog .lbl{font-weight:700}
.mc-prog .pct{font-weight:800;color:var(--primary)}
.mc-bar{height:8px;background:var(--card);border:1px solid var(--border);border-radius:999px;overflow:hidden}
.mc-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--accent));width:0%;transition:width .7s ease}
.mc-prog .meta{display:flex;justify-content:space-between;color:var(--muted);font-size:.8rem;margin-top:6px}

/* time */
.mc-time{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:.9rem}

/* actions: dùng .btn của layout - standardize button sizing/alignment */
.mc-actions{
    margin-top:auto;
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    /* make each action cell equal height so buttons line up */
    align-items:stretch;
}
.mc-actions .btn,
.mc-actions > span {
    flex:1;
    min-width:120px;
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:44px;
    box-sizing:border-box;
    padding:8px 10px;
    border-radius:10px;
    border:1px solid var(--border);
    color:var(--fg);
    font-weight:800;
    text-decoration:none;
    font-size:0.85rem;
}
.mc-actions .btn.secondary{opacity:.95}
.mc-actions > span{background:transparent;border:0}

/* empty state & notices khớp layout */
.notice{
    background:var(--glass);border:1px solid var(--border);border-left:4px solid;
    border-radius:12px;padding:12px 14px;box-shadow:var(--shadow);margin-bottom:12px
}
.notice.ok{border-left-color:#00d4aa}
.notice.err{border-left-color:#ff6b6b}

.mc-empty{background:var(--glass);border:1px solid var(--border);border-radius:var(--radius);
    box-shadow:var(--shadow);text-align:center;padding:48px}
.mc-empty i{font-size:44px;opacity:.85;margin-bottom:10px;display:inline-block}
.mc-empty p{color:var(--muted);margin:6px 0 18px}
.mc-empty .btn{
    padding:12px 18px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    vertical-align:middle;
}
.mc-empty .btn i{font-size:1.05em;line-height:1;display:inline-block}

/* responsive */
@@media (max-width:768px){
    .mc-grid{grid-template-columns:1fr}
    .mc-actions{
        flex-direction:column;
    }
    .mc-actions .btn{
        min-width:unset;
        flex:none;
    }
    .mc-stats{grid-template-columns:1fr}
}
</style>
}

<div class="mc-wrap">
    <div class="mc-hero">
        <h1>Chiến Dịch Của Tôi</h1>
        <p>Quản lý & theo dõi các chiến dịch huy động vốn bạn đã tạo.</p>

        <div class="mc-qacts">
            <a href="@Url.Action("Create")" class="mc-qbtn"><span>Tạo chiến dịch mới</span></a>
            <a href="@Url.Action("Index","Campaigns")" class="mc-qbtn"><i class="fa-solid fa-compass"></i><span>Khám phá dự án</span></a>
            <a href="/Admin" class="mc-qbtn"><i class="fa-solid fa-chart-line"></i><span>Thống kê</span></a>
        </div>

        @if (TempData["SuccessMessage"] != null)
        {
            <div class="notice ok"><i class="fa-solid fa-circle-check"></i> @TempData["SuccessMessage"]</div>
        }
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="notice err"><i class="fa-solid fa-triangle-exclamation"></i> @TempData["ErrorMessage"]</div>
        }
    </div>

    @if (Model?.Any() == true)
    {
        <div class="mc-grid">
            @foreach (var c in Model.OrderByDescending(x => x.CreatedAt))
            {
                var pct = c.GoalAmount > 0 ? (double)c.CurrentRaisedAmount / (double)c.GoalAmount * 100d : 0d;
                var pctStr = pct.ToString("F2", System.Globalization.CultureInfo.InvariantCulture);

                <article class="mc-card">
                    <header class="mc-ch">
                        @{
                            string badgeCls = "badge-pending"; string badgeText = "Chờ duyệt"; string badgeIcon = "fa-clock";
                            if (c.ApprovalStatus == InvestDapp.Shared.Enums.ApprovalStatus.Approved)
                            {
                                badgeCls = "badge-approved"; badgeText = c.Status switch {
                                    InvestDapp.Shared.Enums.CampaignStatus.Active => "Đang gây quỹ",
                                    InvestDapp.Shared.Enums.CampaignStatus.Completed => "Hoàn thành",
                                    InvestDapp.Shared.Enums.CampaignStatus.Voting => "Đang bỏ phiếu",
                                    _ => "Đã duyệt"
                                };
                                badgeIcon = c.Status switch {
                                    InvestDapp.Shared.Enums.CampaignStatus.Active => "fa-play",
                                    InvestDapp.Shared.Enums.CampaignStatus.Completed => "fa-check-circle",
                                    InvestDapp.Shared.Enums.CampaignStatus.Voting => "fa-vote-yea",
                                    _ => "fa-check"
                                };
                            }
                            else if (c.ApprovalStatus == InvestDapp.Shared.Enums.ApprovalStatus.Rejected)
                            { badgeCls="badge-rejected"; badgeText="Bị từ chối"; badgeIcon="fa-times-circle"; }
                        }
                        <div class="mc-badge @badgeCls"><i class="fa-solid @badgeIcon"></i>@badgeText</div>

                        <h3 class="mc-title">
                            <a href="@Url.Action("Details", new { id = c.Id })">@c.Name</a>
                        </h3>
                        <p class="mc-desc">@c.ShortDescription</p>
                        <div class="mc-time"><i class="fa-regular fa-calendar"></i>
                            <span>Tạo lúc @c.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
                        </div>
                    </header>

                    <div class="mc-cb">
                        <div class="mc-stats">
                            <div class="mc-stat">
                                <div class="v">@c.GoalAmount</div>
                                <div class="l">Mục tiêu (BNB)</div>
                            </div>
                            <div class="mc-stat">
                                <div class="v">@c.CurrentRaisedAmount</div>
                                <div class="l">Đã huy động (BNB)</div>
                            </div>
                        </div>

                        <div class="mc-prog">
                            <div class="hd">
                                <div class="lbl">Tiến độ</div>
                                <div class="pct">@((c.GoalAmount>0? (c.CurrentRaisedAmount/c.GoalAmount*100).ToString("F1"):"0"))%</div>
                            </div>
                            <div class="mc-bar">
                                <div class="mc-fill" style="width:@pctStr%"></div>
                            </div>
                            <div class="meta">
                                <span>@c.InvestorCount nhà đầu tư</span>
                                @{
                                    var daysLeft = (c.EndTime - DateTime.UtcNow).Days;
                                    string timeText = daysLeft > 0 ? $"{daysLeft} ngày còn lại" : 
                                                     daysLeft == 0 ? "Hết hạn hôm nay" : 
                                                     "Đã hết hạn";
                                }
                                <span>@timeText</span>
                            </div>
                        </div>

                        <div class="mc-actions">
                            <a class="btn" href="@Url.Action("Details", new { id = c.Id })"><i class="fa-solid fa-eye"></i>&nbsp;Details</a>
                            <a class="btn" href="@Url.Action("Dashboard", new { id = c.Id })"><i class="fa-solid fa-gauge-high"></i>&nbsp;Dashboard</a>

                            @{
                                var isPoolFull = c.CurrentRaisedAmount >= c.GoalAmount;
                                var isPastDeadline = DateTime.UtcNow >= c.EndTime;
                                var canRequestWithdrawal = c.ApprovalStatus == InvestDapp.Shared.Enums.ApprovalStatus.Approved && 
                                                          isPoolFull && isPastDeadline && 
                                                          (c.Status == InvestDapp.Shared.Enums.CampaignStatus.Active || c.Status == InvestDapp.Shared.Enums.CampaignStatus.Voting);
                                var count = c.WithdrawalRequests.Count;
								
                            }

                            @if (canRequestWithdrawal)
                            {
                                if(count < 3)
                                {
                                    <button class="btn" onclick="requestWithdrawal(@c.Id, '@c.Name')" style="background: linear-gradient(135deg,#28a745,#20c997); border:0; color:#fff;" title="Campaign ID: @c.Id">
                                        <i class="fa-solid fa-hand-holding-dollar"></i>&nbsp;Withdrawal
                                    </button>
                                }
                                else if(c.IsRefunded == false)
                                {
                                    <button class="btn" onclick="Refund(@c.Id)" style="background: linear-gradient(135deg,#28a745,#20c997); border:0; color:#fff;" title="Campaign ID: @c.Id">
                                        <i class="fa-solid fa-hand-holding-dollar"></i>&nbsp;Refund
                                    </button>
                                }
                            }
                            else if (c.IsRefunded == false)
                            {
                                <button class="btn" onclick="Refund(@c.Id)" style="background: linear-gradient(135deg,#28a745,#20c997); border:0; color:#fff;" title="Campaign ID: @c.Id">
                                    <i class="fa-solid fa-hand-holding-dollar"></i>&nbsp;Refund
                                </button>
                            }
                        </div>
                    </div>
                </article>
            }
        </div>
    }
    else
    {
        <div class="mc-empty">
            <i class="fa-solid fa-rocket"></i>
            <h3 style="margin:0 0 6px;font-weight:800">Chưa có chiến dịch nào</h3>
            <p>Hãy bắt đầu biến ý tưởng của bạn thành hiện thực.</p>
            <a href="@Url.Action("Create")" class="btn"><i class="fa-solid fa-plus"></i>&nbsp;Tạo chiến dịch đầu tiên</a>
        </div>
    }
</div>

@section Scripts{
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="~/js/contract-config.js"></script>
<script>
// Global variables for blockchain interaction
let provider, signer, contract, userAddress;

// Initialize blockchain connection
async function initializeBlockchain() {
    try {
        // Check if MetaMask is available
        if (typeof window.ethereum === 'undefined') {
            console.warn('MetaMask not detected');
            return false;
        }

        // Request account access
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        
        // Create provider and signer
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        
        // Get user address
        userAddress = await signer.getAddress();
        
        // Create contract instance
        contract = new ethers.Contract(
            window.CONTRACT_CONFIG.CONTRACT_ADDRESS,
            window.CONTRACT_CONFIG.CONTRACT_ABI,
            signer
        );

        return true;
    } catch (error) {
        console.error('Failed to initialize blockchain:', error);
        return false;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    // Initialize blockchain connection on page load
    initializeBlockchain();
    
    // animate progress width sau khi mount
    requestAnimationFrame(() => {
        document.querySelectorAll('.mc-fill').forEach(el => {
            const w = el.style.width; 
            el.style.width = '0%';
            setTimeout(() => el.style.width = w, 50);
        });
    });
});

// Function to request withdrawal from smart contract
async function requestWithdrawal(campaignId, campaignName) {
    try {
        // Ensure blockchain is initialized
        if (!contract) {
            const initialized = await initializeBlockchain();
            if (!initialized) {
                alert('⚠️ Cần MetaMask để thực hiện giao dịch.');
                return;
            }
        }

        // Prompt for withdrawal reason
        const reason = prompt(`Nhập lý do rút vốn cho chiến dịch "${campaignName}":`);
        if (!reason || reason.trim() === '') {
            alert('Vui lòng nhập lý do rút vốn.');
            return;
        }

        // Show loading state
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>&nbsp;Đang gửi lên blockchain...';
        button.disabled = true;

        // === STEP 1: CALL SMART CONTRACT FIRST ===
        console.log('Calling smart contract requestFullWithdrawal...');
        const tx = await contract.requestFullWithdrawal(campaignId, reason.trim());
        
        console.log('Transaction sent to blockchain:', tx.hash);
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>&nbsp;Chờ xác nhận blockchain...';
        
        // Wait for transaction confirmation
        const receipt = await tx.wait();
        console.log('Blockchain transaction confirmed:', receipt);

        // === STEP 2: SEND RESULT TO BACKEND AFTER BLOCKCHAIN SUCCESS ===
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>&nbsp;Cập nhật hệ thống...';
        
        const response = await fetch('/Campaigns/RequestFullWithdrawal', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': window.getRequestVerificationToken()
            },
            body: JSON.stringify({
                campaignId: campaignId,
                txHash: tx.hash,
                reason: reason.trim()
            })
        });

        if (response.ok) {
            alert('✅ Yêu cầu rút vốn đã được thực hiện thành công!\n' +
                  'Giao dịch blockchain: ' + tx.hash + '\n' +
                  'Hệ thống đã được cập nhật.');
            // Reload page to reflect changes
            window.location.reload();
        } else {
            console.warn('Backend update failed:', response.status);
            alert('⚠️ Giao dịch blockchain thành công nhưng không thể cập nhật hệ thống.\n' +
                  'Giao dịch: ' + tx.hash + '\n' +
                  'Vui lòng liên hệ admin để kiểm tra.');
        }

    } catch (error) {
        console.error('Error in withdrawal process:', error);
        
        // Restore button state
        if (event.target) {
            event.target.innerHTML = originalText;
            event.target.disabled = false;
        }

        // Handle specific errors
        if (error.code === 4001) {
            alert('❌ Giao dịch bị hủy bởi người dùng.');
        } else if (error.message.includes('insufficient funds')) {
            alert('❌ Không đủ gas fee để thực hiện giao dịch blockchain.');
        } else if (error.message.includes('execution reverted')) {
            const reason = error.reason || error.data?.message || 'Lỗi không xác định từ smart contract';
            alert('❌ Smart contract từ chối giao dịch:\n' + reason);
        } else if (error.message.includes('user rejected')) {
            alert('❌ Người dùng từ chối ký giao dịch.');
        } else {
            alert('❌ Có lỗi xảy ra: ' + error.message);
        }
    }
}

// Function to handle refund requests
async function Refund(campaignId) {    
    // Debug: Check the campaign ID
    console.log('Refund called with campaignId:', campaignId, 'Type:', typeof campaignId);
    
    // Validate campaign ID
    if (!campaignId || campaignId === 0 || campaignId === '0') {
        alert('❌ Lỗi: Campaign ID không hợp lệ: ' + campaignId);
        console.error('Invalid campaign ID:', campaignId);
        return;
    }
    
    try {
        // Ensure blockchain is initialized
        if (!contract) {
            const initialized = await initializeBlockchain();
            if (!initialized) {
                alert('⚠️ Cần MetaMask để thực hiện giao dịch.');
                return;
            }
        }

        // Show loading state
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>&nbsp;';
        button.disabled = true;

        // === STEP 1: CALL SMART CONTRACT FIRST ===
        console.log('Calling smart contract updateCampaignStatus with ID:', campaignId);
        const tx = await contract.updateCampaignStatus(campaignId);
        
        console.log('Transaction sent to blockchain:', tx.hash);
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>&nbsp;';
        
        // Wait for transaction confirmation
        const receipt = await tx.wait();
        console.log('Blockchain transaction confirmed:', receipt);

        // === STEP 2: SEND RESULT TO BACKEND AFTER BLOCKCHAIN SUCCESS ===
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>&nbsp;Cập nhật hệ thống...';
        const response = await fetch('/Campaigns/Refund', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': window.getRequestVerificationToken()
            },
            body: JSON.stringify({ campaignId: campaignId })
        });
        
        if (response.ok) {
            alert('✅ Yêu cầu hoàn tiền đã được gửi thành công!');
            window.location.reload();
        } else {
            console.warn('Refund request failed:', response.status);
            alert('⚠️ Không thể gửi yêu cầu hoàn tiền. Vui lòng thử lại.');
        }

        // Restore button state
        button.innerHTML = originalText;
        button.disabled = false;

    } catch (error) {
        console.error('Error sending refund request:', error);
        
        // Restore button state
        if (event.target) {
            event.target.innerHTML = originalText;
            event.target.disabled = false;
        }

        // Handle specific errors
        if (error.code === 4001) {
            alert('❌ Giao dịch bị hủy bởi người dùng.');
        } else if (error.message.includes('insufficient funds')) {
            alert('❌ Không đủ gas fee để thực hiện giao dịch blockchain.');
        } else if (error.message.includes('execution reverted')) {
            const reason = error.reason || error.data?.message || 'Lỗi không xác định từ smart contract';
            alert('❌ Smart contract từ chối giao dịch:\n' + reason);
        } else if (error.message.includes('user rejected')) {
            alert('❌ Người dùng từ chối ký giao dịch.');
        } else {
            alert('❌ Có lỗi xảy ra khi gửi yêu cầu hoàn tiền: ' + error.message);
        }
    }
}
</script>
}
