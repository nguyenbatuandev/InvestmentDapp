@model InvestDapp.Models.Campaign
@inject InvestDapp.Infrastructure.Data.InvestDbContext _db
@{
    ViewData["Title"] = Model.Name;
    Layout = "~/Pages/_Layout.cshtml";
}

@Html.AntiForgeryToken()

@section Styles {
<style>
  /* ====== RESET NHẸ & KHUNG TRANG ====== */
  *{ box-sizing: border-box; }
  html,body{ overflow-x:hidden; }
  .campaign-page{ max-width:1200px; margin: calc(var(--header-h) + 28px) auto 60px; padding: 0 16px; }

  /* ====== HERO ====== */
  .hero{
    position:relative; overflow:hidden;
    border:1px solid var(--border); border-radius: var(--radius);
    background: linear-gradient(180deg, rgba(108,240,255,.10), rgba(155,107,255,.06));
    padding: 28px 22px;
  }
  .hero::after{
    content:""; position:absolute; inset:-40% -10% auto auto; width:420px; height:420px;
    background: radial-gradient(closest-side, rgba(255,255,255,.08), rgba(255,255,255,0));
    transform: translate(12%, -12%); pointer-events:none; filter: blur(2px);
  }
  .hero h1{ margin:0 0 8px; font: 800 clamp(22px, 2.4vw, 30px)/1.15 'Plus Jakarta Sans', ui-sans-serif; letter-spacing:.2px; }
  .hero p{ margin:0; color: var(--muted); font-size: clamp(14px, 1.7vw, 16px); }
  .chip{
    display:inline-flex; align-items:center; gap:8px; margin-top:10px;
    padding:8px 12px; border-radius:12px; font-weight:700; font-size:.9rem; border:1px solid var(--border);
    background: rgba(255,255,255,.05);
  }
  .chip.pending{ color:#ffc107; border-color: rgba(255,193,7,.35); background: rgba(255,193,7,.12); }
  .chip.approved{ color:#00d4aa; border-color: rgba(0,212,170,.35); background: rgba(0,212,170,.10); }
  .chip.rejected{ color:#ff6b6b; border-color: rgba(255,107,107,.35); background: rgba(255,107,107,.10); }
  .chip.completed{ color:#28a745; border-color: rgba(40,167,69,.35); background: rgba(40,167,69,.10); }

  /* ====== LƯỚI NỘI DUNG ====== */
  .grid{
    display:grid; gap: 22px; margin-top: 18px;
    grid-template-columns: 2fr 1fr;
  }
  @@media (max-width: 992px){ .grid{ grid-template-columns: 1fr; } }

  /* ====== CARD CHUẨN ====== */
  .card{
    border:1px solid var(--border); border-radius: var(--radius);
    background: var(--glass); box-shadow: var(--shadow); padding: 18px;
  }
  .card h3{
    margin:0 0 12px; font-size: 1.05rem; font-weight:800; letter-spacing:.2px; color: var(--primary);
    display:flex; align-items:center; gap:10px;
  }

  /* ====== STATS ====== */
  .stats{
    display:grid; gap: 14px; grid-template-columns: repeat(4, 1fr); margin-top: 16px;
  }
  @@media (max-width: 992px){ .stats{ grid-template-columns: repeat(2,1fr); } }
  @@media (max-width: 520px){ .stats{ grid-template-columns: 1fr; } }
  .stat{
    border:1px solid var(--border); background: rgba(255,255,255,.04);
    border-radius: 12px; padding: 16px; text-align:center; transition: transform .15s;
  }
  .stat:hover{ transform: translateY(-2px); }
  .stat i{ font-size: 1.4rem; color: var(--primary); margin-bottom: 6px; display:block; }
  .stat .val{ font: 800 1.3rem/1 'Fira Code', ui-monospace; }
  .stat .lbl{ color: var(--muted); font-size: .85rem; }

  /* ====== PROGRESS ====== */
  .progress-box{ margin-top: 6px; }
  .progress-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom: 6px; }
  .progress{ height: 12px; border-radius: 999px; background: rgba(255,255,255,.06); border:1px solid var(--border); overflow:hidden; }
  .progress .fill{ height:100%; width:0; background: linear-gradient(90deg, var(--primary), var(--accent)); transition: width .6s ease; }
  .progress-info{ display:flex; justify-content:space-between; color: var(--muted); font-size:.85rem; margin-top: 4px; }

  /* ====== MÔ TẢ ====== */
  .desc{ color: var(--fg); line-height: 1.75; }
  .desc p{ margin: 0 0 10px; }
  .desc img{ max-width:100%; height:auto; border-radius:10px; border:1px solid var(--border); }
  .desc a{ color: var(--primary); text-decoration: underline; }

  /* ====== SIDEBAR ====== */
  .owner{
    display:flex; align-items:center; gap:12px; padding: 12px; border-radius: 12px;
    background: rgba(255,255,255,.03); border:1px solid var(--border);
  }
  .owner .ava{
    width:44px; height:44px; border-radius:50%; display:grid; place-items:center;
    background: conic-gradient(from 160deg,#6cf0ff,#9b6bff,#6cf0ff); color:#04121c; font-weight:900;
    border: 1px solid var(--border);
  }
  .owner .addr{ color: var(--muted); font-family: ui-monospace, 'Fira Code', monospace; font-size: .9rem; word-break: break-all; }

  .media img{ width:100%; max-width:100%; display:block; border-radius: 12px; border:1px solid var(--border); }

  .actions{ display:grid; gap:10px; }
  .act{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:12px 14px; border-radius:12px; border:1px solid var(--border); font-weight:800; text-decoration:none; }
  .act.primary{ background: linear-gradient(135deg, rgba(108,240,255,.18), rgba(155,107,255,.18)); color: var(--fg); }
  .act.secondary{ background: rgba(255,255,255,.04); color: var(--fg); }
  .act:disabled, .act[disabled]{ opacity:.6; cursor:not-allowed; }

  /* ====== CARDS NHỎ ====== */
  .side-card + .side-card{ margin-top: 16px; }
  .side-title{ margin:0 0 10px; font-weight:800; color: var(--primary); font-size: 1rem; }

  /* ====== MODAL SỬA LẠI (không tràn viền) ====== */
  .modal{ position: fixed; z-index: 9999; inset:0; display:none; background: rgba(0,0,0,.6); }
  .modal .modal-content{
    width: min(1100px, 96vw); max-height: 88vh; overflow: visible; margin: 4vh auto 0;
    padding: 20px; border-radius: 14px; border:1px solid var(--border); background: rgba(8,10,14,.98);
  }
  .modal .row{ display:grid; gap:10px; }
  .modal textarea, .modal input[type="number"]{
    width:100%; padding: 10px 12px; background: rgba(255,255,255,.03); border:1px solid var(--border);
    border-radius: 10px; color: var(--fg);
  }
  .modal .footer{ display:flex; gap:10px; justify-content:flex-end; margin-top: 12px; }
  .btn-flat{ padding:10px 12px; border-radius: 10px; border:1px solid var(--border); background: rgba(255,255,255,.04); color: var(--fg); }
  .btn-grad{ padding:10px 12px; border-radius: 10px; border:0; background: linear-gradient(135deg,#28a745,#20c997); color:#fff; font-weight:800; }

  /* Claims table inside modal: show up to 5 rows, scroll if more. Prevent row wrapping so height stays consistent */
  :root { --claims-row-h: 48px; }
  #claimsListHost { max-height: calc(var(--claims-row-h) * 5 + 64px); overflow:auto; }
  #claimsListHost table { width:100%; border-collapse:collapse; table-layout: fixed; }
  #claimsListHost thead th { padding:8px; vertical-align:middle; }
  #claimsListHost th, #claimsListHost td { padding:8px; vertical-align:middle; }
  #claimsListHost tbody tr { height: var(--claims-row-h); max-height: var(--claims-row-h); }
  #claimsListHost td { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  #claimsListHost .claims-tx a { display:inline-block; max-width:260px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color:var(--primary); }
  @@media (max-width: 600px) {
    .modal .modal-content { width: 96vw; margin: 3vh auto 0; padding: 14px; }
    #claimsListHost .claims-tx a { max-width:120px; }
    #claimsListHost td { white-space:normal; }
    #claimsListHost tbody tr { height: auto; }
  }
</style>
}


<div class="campaign-page">
  <!-- HERO -->
  <section class="hero">
    <h1>@Model.Name</h1>
    <p>@Model.ShortDescription</p>

    @switch (Model.ApprovalStatus)
    {
      case InvestDapp.Shared.Enums.ApprovalStatus.Pending:
        <span class="chip pending"><i class="fas fa-clock"></i> Chờ duyệt</span>; break;
      case InvestDapp.Shared.Enums.ApprovalStatus.Approved:
        <span class="chip approved"><i class="fas fa-check-circle"></i> Đã duyệt</span>; break;
      case InvestDapp.Shared.Enums.ApprovalStatus.Rejected:
        <span class="chip rejected"><i class="fas fa-times-circle"></i> Từ chối</span>; break;
    }

    <!-- STAT BLOCK ngay trong hero cho cân bố cục -->
    <div class="stats">
      <div class="stat">
        <i class="fas fa-coins"></i>
        <div class="val">@Model.GoalAmount BNB</div>
        <div class="lbl">Mục tiêu</div>
      </div>
      <div class="stat">
        <i class="fas fa-chart-line"></i>
        <div class="val">@Model.CurrentRaisedAmount BNB</div>
        <div class="lbl">Đã huy động</div>
      </div>
      <div class="stat">
        <i class="fas fa-users"></i>
        <div class="val">@Model.InvestorCount</div>
        <div class="lbl">Nhà đầu tư</div>
      </div>
      <div class="stat">
        <i class="fas fa-calendar-alt"></i>
        <div class="val">@((Model.EndTime - DateTime.UtcNow).Days)</div>
        <div class="lbl">Ngày còn lại</div>
      </div>
    </div>
  </section>

  <!-- GRID -->
  <section class="grid">
    @{
      var currentUserWallet = User.FindFirst("WalletAddress")?.Value;
      var isOwner = currentUserWallet == Model.OwnerAddress;
      var isInvestor = Model.Investments?.Any(i => i.InvestorAddress.Equals(currentUserWallet, StringComparison.OrdinalIgnoreCase)) ?? false;
    }
    <!-- MAIN -->
    <article class="card">

      @* Replace posts with admin-added profits list. Only owners see the add form; only investors (and owner) see the profit list and claim buttons. *@
      @if (isOwner || isInvestor)
      {
        <div style="margin-top:18px;">
          <h3><i class="fas fa-gift"></i> Lợi nhuận</h3>

          @* Owner uses the sidebar "Thêm lợi nhuận" popup button; no inline add form here to avoid duplicates *@

          <div id="profit-list">
            @if (Model.Profits?.Any() == true)
            {
              // Display profits newest-first, but compute on-chain profit index from ascending Id order
              var profits = Model.Profits.OrderByDescending(pr => pr.CreatedAt).ToList();
              var profitsForIndex = Model.Profits.OrderBy(pr => pr.Id).ToList();
              var profitIndexMap = profitsForIndex.Select((p, idx) => new { p.Id, idx }).ToDictionary(x => x.Id, x => x.idx);
              <style>
                /* Table-like list with card rows */
                .table-profits { width:100%; border-collapse:separate; border-spacing:0 12px; }
                .table-profits thead th { padding:10px 16px; text-align:left; color:var(--muted); font-weight:700; }
                /* Make tbody rows look like cards (more prominent) */
                .table-profits tbody tr {
                  background: linear-gradient(180deg, rgba(30,36,43,0.95), rgba(18,20,24,0.95));
                  border: 1px solid rgba(255,255,255,0.06);
                  border-radius:16px;
                  box-shadow: 0 10px 30px rgba(6,10,14,0.18);
                  transition: transform .14s cubic-bezier(.2,.9,.2,1), box-shadow .14s ease;
                  position:relative; overflow:hidden;
                }
                /* subtle accent bar on the left */
                .table-profits tbody tr::before{
                  content:""; position:absolute; left:0; top:8px; bottom:8px; width:6px; border-radius:8px; background: linear-gradient(180deg, var(--primary), var(--accent)); box-shadow: 0 6px 18px rgba(0,0,0,0.25);
                }
                /* reserve space so the accent bar doesn't overlap content */
                .table-profits thead th:first-child,
                .table-profits tbody td:first-child { padding-left: 40px; }
                .table-profits tbody tr:hover{ transform: translateY(-8px); box-shadow: 0 18px 44px rgba(6,10,14,0.24); }
                .table-profits tbody td { padding:14px 24px; vertical-align:middle; color: rgba(255,255,255,0.92); }
                .table-profits .col-action { width:1%; white-space:nowrap; }
                /* compact amount styling */
                .table-profits td strong{ color: #e6fffb; font-weight:900; font-size:1.02rem; }
                .table-profits td small, .table-profits td .muted{ color: rgba(255,255,255,0.6); }
                /* compact amount styling */
                .table-profits td strong{ color: var(--success); font-weight:800; }
                /* responsive fallback: stack cells on small screens */
                @@media (max-width:600px){ 
                  .table-profits thead{ display:none; }
                  .table-profits tbody tr{ display:block; padding:12px; }
                  .table-profits tbody td{ display:block; width:100%; padding:6px 0; }
                  .table-profits tbody td.col-action{ margin-top:8px; }
                }
              </style>

              @* compute investor percent once (read-only display) *@
              double investorPercent = 0.0;
              try {
                if (isInvestor) {
                  var myInv = Model.Investments?.Where(i => i.InvestorAddress.Equals(currentUserWallet, StringComparison.OrdinalIgnoreCase)).Sum(i => (double)i.Amount) ?? 0.0;
                  var total = (double)(Model.CurrentRaisedAmount);
                  if (total > 0) investorPercent = Math.Round(myInv / total * 100.0, 2);
                }
              } catch {
                investorPercent = 0.0;
              }

              // Which profits the current user already claimed (server-side check via DB)
              var claimedSet = new HashSet<int>();
              try {
                if (!string.IsNullOrEmpty(currentUserWallet)) {
                  var list = _db.ProfitClaims
                    .Where(pc => pc.ClaimerWallet.ToLower() == currentUserWallet.ToLower())
                    .Select(pc => pc.ProfitId)
                    .ToList();
                  claimedSet = new HashSet<int>(list);
                }
              } catch {
                claimedSet = new HashSet<int>();
              }
                // Prepare claims data (serialize to JS) for the current campaign profits
                var profitIds = profits.Select(p => p.Id).ToList();
                var profitAmountMap = profits.ToDictionary(p => p.Id, p => (double)p.Amount);
                var totalRaised = (double)(Model.CurrentRaisedAmount);
                // Build a map of invested amounts per wallet (use correct shared model namespace)
                var investList = Model.Investments ?? new List<InvestDapp.Shared.Models.Investment>();
                var investMap = investList
                  .GroupBy(i => (i.InvestorAddress ?? "").ToLower())
                  .ToDictionary(g => g.Key, g => (double)g.Sum(i => i.Amount));

                var rawClaims = _db.ProfitClaims
                  .Where(pc => profitIds.Contains(pc.ProfitId))
                  .Select(pc => new { pc.ProfitId, pc.ClaimerWallet, pc.TransactionHash, pc.ClaimedAt })
                  .ToList();

                var claimsDict = rawClaims.GroupBy(x => x.ProfitId)
                  .ToDictionary(g => g.Key, g => g.Select(y => new {
                    wallet = y.ClaimerWallet,
                    tx = y.TransactionHash,
                    at = y.ClaimedAt,
                    invested = investMap.ContainsKey((y.ClaimerWallet ?? "").ToLower()) ? investMap[(y.ClaimerWallet ?? "").ToLower()] : 0.0,
                    profitAmount = profitAmountMap.ContainsKey(y.ProfitId) ? profitAmountMap[y.ProfitId] : 0.0,
                    totalRaised = totalRaised
                  }).ToList());

                <script>
                  window.__CLAIMS_DATA = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(claimsDict));
                </script>

              <div class="table-responsive">
                <table class="table table-profits mb-0">
                  <thead>
                    <tr>
                      <th></th>
                      <th style="width:48px">STT</th>
                      <th>Lợi nhuận</th>
                      <th style="width:120px">Phần trăm</th>
                      <th>Thời gian</th>
                      <th class="col-action">Hành động</th>
                    </tr>
                  </thead>
                  <tbody>
                  @for (int i = 0; i < profits.Count; i++)
                  {
                    var p = profits[i];
                    // Determine the on-chain profit index (position inside the contract's list)
                    var onChainIndex = profitIndexMap.ContainsKey(p.Id) ? profitIndexMap[p.Id] : i;
                    <tr>
                      <td>@(i + 1)</td>
                      <td><strong>@p.Amount</strong> BNB</td>
                      <td>
                        @if (isInvestor)
                        {
                          <span style="font-weight:800">@investorPercent%</span>
                        }
                        else
                        {
                          <span class="muted">-</span>
                        }
                      </td>
                      <td>@p.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                      <td class="col-action" style="display:flex; gap:8px; align-items:center;">
                        @if (isInvestor)
                        {
                          if (claimedSet.Contains(p.Id))
                          {
                            <span class="btn btn-secondary" style="cursor:default; opacity:0.9;">Đã nhận</span>
                            <button class="btn btn-flat" onclick="openClaimsModal(@p.Id)">Danh sách</button>
                          }
                          else
                          {
                            <button class="btn btn-success" onclick="claimProfit(@Model.Id, @p.Id, this)"><i class="fas fa-money-bill-wave"></i> Nhận</button>
                            <button class="btn btn-flat" onclick="openClaimsModal(@p.Id)">Danh sách</button>
                          }
                        }
                        else
                        {
                          <button class="btn btn-flat" onclick="openClaimsModal(@p.Id)">Danh sách</button>
                        }
                      </td>
                    </tr>
                  }
                  </tbody>
                </table>
              </div>
            }
            else
            {
              <p class="muted">Chưa có lợi nhuận nào được thêm.</p>
            }
          </div>
        </div>
      }
    </article>

    <!-- SIDEBAR -->
    <aside class="side">
      <!-- PROGRESS -->
      <div class="card side-card">
        <h3><i class="fas fa-tasks"></i> Tiến độ</h3>
        <div class="progress-box">
          <div class="progress-head">
            <span style="font-weight:700">Hoàn thành</span>
            <span style="color:var(--primary); font-weight:800;">
              @(Model.GoalAmount > 0 ? (Model.CurrentRaisedAmount / Model.GoalAmount * 100).ToString("F1") : "0")%
            </span>
          </div>
          <div class="progress">
            @{
              var _pct = Model.GoalAmount > 0 ? (Model.CurrentRaisedAmount / Model.GoalAmount * 100) : 0;
              var _pctStr = _pct.ToString("F2", System.Globalization.CultureInfo.InvariantCulture);
            }
            <div class="fill" style="width:@_pctStr%"></div>
          </div>
          <div class="progress-info">
            <span>@Model.CurrentRaisedAmount BNB</span>
            <span>@Model.GoalAmount BNB</span>
          </div>
          <div class="progress-info" style="margin-top:4px">
            <i class="fas fa-clock" aria-hidden="true"></i>
            <span style="margin-left:6px">Kết thúc: <b>@Model.EndTime.ToString("dd/MM/yyyy HH:mm")</b></span>
          </div>
        </div>
      </div>

      <!-- OWNER -->
      <div class="card side-card">
        <h3><i class="fas fa-user-circle"></i> Người tạo</h3>
        <div class="owner">
          <div class="ava">@Model.OwnerAddress?.Substring(0,2).ToUpper()</div>
          <div>
            <div style="font-weight:800">Chủ dự án</div>
            <div class="addr">@Model.OwnerAddress</div>
          </div>
        </div>
      </div>

      @if (!string.IsNullOrEmpty(Model.ImageUrl))
      {
        <div class="card side-card media">
          <h3><i class="fas fa-image"></i> Hình ảnh</h3>
          <img src="@Model.ImageUrl" alt="@Model.Name" />
        </div>
      }

      <!-- ACTIONS -->
      <div class="card side-card">
        <div class="actions">

          <a href="@Url.Action("Dashboard", new { id = Model.Id })" class="act primary">
            <i class="fas fa-tachometer-alt"></i> Xem Dashboard
          </a>

          @if (isOwner)
          {
            <!-- Owner actions (UI only, giữ nguyên onclick/flow) -->
            @if (Model.ApprovalStatus == InvestDapp.Shared.Enums.ApprovalStatus.Approved)
            {
              @switch (Model.Status)
              {
                case InvestDapp.Shared.Enums.CampaignStatus.Active:
                  <button class="act primary" onclick="requestWithdrawal(@Model.Id)">
                    <i class="fas fa-hand-holding-usd"></i> Yêu cầu rút vốn
                  </button>
                  break;

                case InvestDapp.Shared.Enums.CampaignStatus.Voting:
                  var hasPending = Model.WithdrawalRequests?.Any(w => w.Status == InvestDapp.Shared.Enums.WithdrawalStatus.Pending) == true;
                  var rejectedCount = Model.WithdrawalRequests?.Count(w => w.Status == InvestDapp.Shared.Enums.WithdrawalStatus.Rejected) ?? 0;
                  var canCreateNewAttempt = !hasPending && rejectedCount < 2;

                  @if (hasPending)
                  {
                    <button class="act secondary" onclick="checkWithdrawalExecution(@Model.Id)">
                      <i class="fas fa-check-circle"></i> Kiểm tra kết quả vote
                    </button>
                  }
                  else if (canCreateNewAttempt)
                  {
                    <button class="act primary" onclick="requestWithdrawal(@Model.Id)">
                      <i class="fas fa-hand-holding-usd"></i> Yêu cầu rút vốn (Lần @((Model.WithdrawalRequests?.Count() ?? 0) + 1))
                    </button>
                  }
                  else
                  {
                    <span class="act secondary" style="cursor:default; opacity:.85;">
                      <i class="fas fa-vote-yea"></i> Đang trong quá trình vote
                    </span>
                  }
                  break;

                case InvestDapp.Shared.Enums.CampaignStatus.Completed:
                  <button class="act primary" onclick="addProfitToCampaign(@Model.Id)">
                    <i class="fas fa-plus-circle"></i> Thêm lợi nhuận
                  </button>
                  break;

                case InvestDapp.Shared.Enums.CampaignStatus.Failed:
                  <span class="act secondary" style="cursor:default; opacity:.85;">
                    <i class="fas fa-times-circle"></i> Chiến dịch đã thất bại
                  </span>
                  break;

                default:
                  <span class="act secondary" style="cursor:default; opacity:.85;">
                    <i class="fas fa-info-circle"></i> Không có hành động khả dụng
                  </span>
                  break;
              }
            }
          }
          else if (Model.ApprovalStatus == InvestDapp.Shared.Enums.ApprovalStatus.Pending)
          {
            <span class="act secondary" style="cursor:default; opacity:.85;">
              <i class="fas fa-clock"></i> Chờ duyệt chiến dịch
            </span>
          }
          else if (Model.ApprovalStatus == InvestDapp.Shared.Enums.ApprovalStatus.Rejected)
          {
            <span class="act secondary" style="cursor:default; opacity:.85;">
              <i class="fas fa-times-circle"></i> Chiến dịch bị từ chối
            </span>
          }
          else if (Model.ApprovalStatus == InvestDapp.Shared.Enums.ApprovalStatus.Approved)
          {
            @switch (Model.Status)
            {
              case InvestDapp.Shared.Enums.CampaignStatus.Active:
                <button class="act primary" onclick="investInCampaign(@Model.Id)">
                  <i class="fas fa-dollar-sign"></i> Đầu tư ngay
                </button>
                break;

              case InvestDapp.Shared.Enums.CampaignStatus.Voting:
                @if (isInvestor)
                {
                  <button class="act primary" onclick="voteOnCampaign(@Model.Id)">
                    <i class="fas fa-vote-yea"></i> Bỏ phiếu
                  </button>
                  @if (Model.WithdrawalRequests?.Any(w => w.Status == InvestDapp.Shared.Enums.WithdrawalStatus.Pending) == true)
                  {
                    <button class="act secondary" onclick="checkWithdrawalExecution(@Model.Id)">
                      <i class="fas fa-check-circle"></i> Kiểm tra kết quả vote
                    </button>
                  }
                }
                else
                {
                  <span class="act secondary" title="Chỉ nhà đầu tư mới có quyền bỏ phiếu" style="cursor:default; opacity:.85;">
                    <i class="fas fa-lock"></i> Bỏ phiếu (Chỉ nhà đầu tư)
                  </span>
                }
                break;

              case InvestDapp.Shared.Enums.CampaignStatus.Failed:
                @if (isInvestor)
                {
                  <button class="act primary" onclick="claimRefund(@Model.Id)">
                    <i class="fas fa-money-bill-wave"></i> Claim lại tiền
                  </button>
                }
                else
                {
                  <span class="act secondary" title="Chỉ nhà đầu tư mới có thể claim" style="cursor:default; opacity:.85;">
                    <i class="fas fa-lock"></i> Claim (Chỉ nhà đầu tư)
                  </span>
                }
                break;

              case InvestDapp.Shared.Enums.CampaignStatus.Completed:
                @if (isInvestor)
                {
                  <button class="act primary" onclick="claimProfits(@Model.Id)">
                    <i class="fas fa-gift"></i> Nhận lợi nhuận
                  </button>
                }
                <span class="act secondary" style="cursor:default; opacity:.85;">
                  <i class="fas fa-check-circle"></i> Đã hoàn thành
                </span>
                break;

              default:
                <span class="act secondary" style="cursor:default; opacity:.85;">
                  <i class="fas fa-clock"></i> Đang chuẩn bị
                </span>
                break;
            }
          }
        </div>
      </div>
    </aside>
  </section>
</div>


<!-- ====== MODALS: Withdrawal & Profit ====== -->
<!-- Withdrawal Modal -->
<div id="withdrawalModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Yêu cầu rút vốn</h3>
    <form id="withdrawalForm">
      <div class="row">
        <label for="withdrawalReason">Lý do</label>
        <textarea id="withdrawalReason" name="reason" rows="5" placeholder="Nhập lý do rút vốn (ít nhất 10 ký tự)"></textarea>
      </div>
      <div class="footer">
        <button type="button" class="btn-flat" onclick="closeWithdrawalModal()">Hủy</button>
        <button id="submitWithdrawal" type="submit" class="btn-grad"><i class="fas fa-paper-plane"></i> Gửi Yêu Cầu</button>
      </div>
    </form>
  </div>
</div>

<!-- Profit Modal -->
<div id="profitModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Thêm lợi nhuận vào chiến dịch</h3>
    <form id="profitForm">
      <div class="row">
        <label for="profitAmount">Số BNB</label>
        <input id="profitAmount" name="amount" type="number" step="0.001" placeholder="0.001" />
      </div>
      <div class="footer">
        <button type="button" class="btn-flat" onclick="closeProfitModal()">Hủy</button>
        <button id="submitProfit" type="submit" class="btn-grad"><i class="fas fa-plus"></i> Thêm</button>
      </div>
    </form>
  </div>
</div>

<!-- Claims List Modal -->
<div id="claimsListModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Danh sách đã nhận</h3>
    <div id="claimsListHost" style="max-height:40vh; overflow:auto;">
      <!-- Filled dynamically -->
    </div>
    <div class="footer">
      <button type="button" class="btn-flat" onclick="closeClaimsModal()">Đóng</button>
    </div>
  </div>
</div>

@section Scripts {
  <!-- Load ethers & contract config (once) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="~/js/contract-config.js" asp-append-version="true"></script>

  <script>
  // Claims data prepared server-side (populated earlier into window.__CLAIMS_DATA)
  const CLAIMS_DATA = window.__CLAIMS_DATA || {};

    function openClaimsModal(profitId){
      const host = document.getElementById('claimsListHost');
      host.innerHTML = '';
      const list = CLAIMS_DATA[profitId] || [];
      if (list.length === 0){
        host.innerHTML = '<p class="muted">Chưa có ai nhận.</p>';
      } else {
        // Compute how many times each wallet appears (số lượng claim)
        const counts = {};
        list.forEach(it => { const w = (it.wallet||'').toLowerCase(); counts[w] = (counts[w]||0) + 1; });

        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.innerHTML = `
          <thead>
            <tr style="text-align:left; border-bottom:1px solid rgba(255,255,255,0.06);">
              <th style="padding:8px">STT</th>
              <th style="padding:8px">Wallet</th>
              <th style="padding:8px">TxHash</th>
              <th style="padding:8px">Số BNB</th>
              <th style="padding:8px">Thời gian</th>
            </tr>
          </thead>
        `;

        const tbody = document.createElement('tbody');
        list.forEach((item, idx) => {
          const tr = document.createElement('tr');
          tr.style.borderBottom = '1px solid rgba(255,255,255,0.03)';
          tr.style.padding = '6px 0';

          const wallet = item.wallet || '';
          const tx = item.tx || item.transactionHash || '';
          const at = item.at ? new Date(item.at).toLocaleString() : '-';
          const shortTx = tx ? (tx.length > 14 ? tx.substr(0,10) + '...' + tx.substr(tx.length-4) : tx) : '-';
          // Compute claimed BNB: (invested / totalRaised) * profitAmount
          const invested = Number(item.invested || 0);
          const profitAmount = Number(item.profitAmount || 0);
          const totalRaised = Number(item.totalRaised || 0) || 1; // avoid div0
          let claimed = 0;
          if (totalRaised > 0) claimed = (invested / totalRaised) * profitAmount;
          // Round to 3 decimals
          claimed = Math.round(claimed * 1000) / 1000;

          tr.innerHTML = `
            <td style="padding:8px; vertical-align:middle">${idx + 1}</td>
            <td style="padding:8px; vertical-align:middle; font-family:ui-monospace, 'Fira Code'">${wallet}</td>
            <td style="padding:8px; vertical-align:middle; font-family:ui-monospace, 'Fira Code'"><a href="https://testnet.bscscan.com/tx/${tx}" target="_blank" style="color:var(--primary); text-decoration:underline">${shortTx}</a></td>
            <td style="padding:8px; vertical-align:middle">${claimed} BNB</td>
            <td style="padding:8px; vertical-align:middle; color:var(--muted)">${at}</td>
          `;

          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        host.appendChild(table);
      }
      const m = document.getElementById('claimsListModal'); if (m) m.style.display='block';
    }
    function closeClaimsModal(){ const m = document.getElementById('claimsListModal'); if (m) m.style.display='none'; }
    /*********************** Toast helpers ************************/
    function createToast(message, kind){
      const el = document.createElement('div');
      el.className = 'toast ' + (kind==='ok'?'ok':'bad');
      el.style.cssText = `
        position:fixed;top:20px;right:20px;z-index:99999;padding:12px 14px;border-radius:12px;
        color:#fff;font-weight:800;background:${kind==='ok'?'linear-gradient(135deg,#28a745,#20c997)':'linear-gradient(135deg,#dc3545,#e74c3c)'};
        box-shadow:0 6px 20px rgba(0,0,0,.25)
      `;
      el.innerHTML = `<i class="fas ${kind==='ok'?'fa-check-circle':'fa-exclamation-triangle'}"></i> ${message}`;
      document.body.appendChild(el); setTimeout(()=>el.remove(), 4500);
    }
    const showSuccess = (m)=>createToast(m,'ok');
    const showError   = (m)=>createToast(m,'bad');

    /*********************** Global web3 vars ************************/
    let web3, contract, userAccount;

    /*********************** Load ethers fallback (optional) ************************/
    function ensureEthersLoaded() {
      return new Promise((resolve, reject) => {
        if (typeof ethers !== 'undefined') { resolve(); return; }
        const cdns = [
          'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js'
        ];
        const tryLoad = (i) => {
          if (i >= cdns.length) { reject(new Error('Failed to load Ethers.js')); return; }
          const s = document.createElement('script');
          s.src = cdns[i];
          s.onload = () => resolve();
          s.onerror = () => tryLoad(i+1);
          document.head.appendChild(s);
        };
        tryLoad(0);
      });
    }

    /*********************** Network switch ************************/
    async function switchToBSCTestnet(){
      const rpcUrls = [
        'https://bsc-testnet.publicnode.com',
        'https://bsc-testnet-rpc.publicnode.com',
        'https://data-seed-prebsc-1-s1.binance.org:8545/',
        'https://endpoints.omniatech.io/v1/bsc/testnet/public',
        'https://rpc.ankr.com/bsc_testnet'
      ];
      try{
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: CONTRACT_CONFIG.EXPECTED_CHAIN_ID_HEX }],
        });
        return true;
      }catch(switchError){
        if (switchError.code === 4902){
          try{
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: CONTRACT_CONFIG.EXPECTED_CHAIN_ID_HEX,
                chainName: 'BSC Testnet',
                nativeCurrency: { name:'BNB', symbol:'BNB', decimals:18 },
                rpcUrls,
                blockExplorerUrls: ['https://testnet.bscscan.com/']
              }]
            });
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: CONTRACT_CONFIG.EXPECTED_CHAIN_ID_HEX }],
            });
            return true;
          }catch(addErr){
            if (addErr.code === 4001) showError('Bạn đã từ chối thêm BSC Testnet.');
            else showError('Không thể thêm BSC Testnet.');
            return false;
          }
        }else if (switchError.code === 4001){
          showError('Bạn đã từ chối chuyển mạng.');
          return false;
        }else{
          showError('Không thể chuyển sang BSC Testnet.');
          return false;
        }
      }
    }

    /*********************** Init web3 + contract ************************/
    async function initializeWeb3(){
      try{
        await ensureEthersLoaded();
        if (typeof window.ethereum === 'undefined'){ showError('Vui lòng cài MetaMask để sử dụng!'); return false; }

        web3 = new ethers.providers.Web3Provider(window.ethereum, 'any');

        // yêu cầu account (timeout 15s)
        const accounts = await Promise.race([
          window.ethereum.request({ method:'eth_requestAccounts' }),
          new Promise((_,rej)=>setTimeout(()=>rej(new Error('Connection timeout')),15000))
        ]);
        if (!accounts || accounts.length===0) throw new Error('No accounts found');

        let signer = web3.getSigner();
        userAccount = await signer.getAddress();

        const net = await web3.getNetwork();
        if (net.chainId !== CONTRACT_CONFIG.EXPECTED_CHAIN_ID_DEC){
          const ok = await switchToBSCTestnet();
          if (!ok) throw new Error('Failed to switch network');
          web3 = new ethers.providers.Web3Provider(window.ethereum, 'any');
          signer = web3.getSigner();
          userAccount = await signer.getAddress();
        }

        contract = new ethers.Contract(CONTRACT_CONFIG.CONTRACT_ADDRESS, CONTRACT_CONFIG.CONTRACT_ABI, signer);
        await contract.campaignCounter(); // ping view để chắc kết nối ok

        return true;
      }catch(err){
        console.error('Web3 init error:', err);
        if (err.code === 4001) showError('Bạn đã từ chối kết nối ví.');
        else if (err.code === -32002) showError('Yêu cầu kết nối đang chờ trong MetaMask.');
        else if (err.message === 'Connection timeout') showError('Kết nối ví bị timeout.');
        else if (err.message === 'No accounts found') showError('Vui lòng unlock MetaMask.');
        else showError(err.message || 'Không thể kết nối với ví.');
        return false;
      }
    }

    async function ensureWalletConnected(){
      if (!web3 || !contract || !userAccount) return await initializeWeb3();
      return true;
    }

    /*********************** Withdrawal flow (ABI fallback ready) ************************/
    function requestWithdrawal(){ const m = document.getElementById('withdrawalModal'); if (m) m.style.display = 'block'; }
    function closeWithdrawalModal(){
      const m = document.getElementById('withdrawalModal'); if (m) m.style.display='none';
      const f = document.getElementById('withdrawalForm'); if (f) f.reset();
    }

    async function submitWithdrawalRequest(campaignId, reason){
      const btn = document.getElementById('submitWithdrawal');
      const originalText = btn?.innerHTML;
      try{
        if (!await ensureWalletConnected()) return;

        // validate
        if (!reason || reason.trim().length < 1){ showError('Vui lòng nhập lý do rút vốn'); return; }

        if (btn){ btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang kiểm tra điều kiện...'; }

        // kiểm tra owner + trạng thái on-chain
        const c = await contract.campaigns(campaignId);
        const owner = (c.owner || c[1] || '').toString();
        const goal = ethers.BigNumber.from(c.goalAmount || c[3] || 0);
        const raised = ethers.BigNumber.from(c.currentRaisedAmount || c[4] || 0);
        const end = parseInt((c.endTime || c[6] || 0).toString(),10);
        const status = parseInt((c.status || c[7] || 0).toString(),10);

        if (owner.toLowerCase() !== userAccount.toLowerCase()) { showError('❌ Chỉ chủ chiến dịch mới yêu cầu rút vốn'); return; }
        const now = Math.floor(Date.now()/1000);
        // Tuỳ logic của bạn, có thể mở comment để chặn sớm:
        // if (raised.lt(goal)) { showError('❌ Chưa đạt mục tiêu.'); return; }
        // if (now < end) { showError('❌ Chưa đến thời điểm kết thúc chiến dịch.'); return; }
        if (!(status === 0 || status === 1)) { showError('❌ Trạng thái hiện tại không cho phép rút vốn.'); return; }

        // Check pending requests (best-effort)
        try{
          const limit = 20;
          for (let i=0;i<limit;i++){
            try{
              const req = await contract.withdrawalRequests(campaignId, i);
              const st = (req.status && req.status.toNumber) ? req.status.toNumber() : parseInt((req.status || 0).toString(),10);
              if (st === 0){ showError('❌ Đã tồn tại yêu cầu rút vốn đang chờ xử lý.'); return; }
            }catch{ break; }
          }
        }catch(e){ console.warn('Scan pending withdrawal failed (non-fatal):', e); }

        if (btn){ btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kiểm tra on-chain...'; }

        // Preflight 2-arg -> nếu revert silent => fallback 1-arg
        let useLegacyOneArg = false;
        try{
          await contract.callStatic.requestFullWithdrawal(campaignId, reason.trim());
        }catch(preflightErr){
          const msg = (preflightErr?.message||'').toLowerCase();
          const data = preflightErr?.data || preflightErr?.error?.data || '0x';
          if (msg.includes('missing trie node')) { showError('❌ RPC node lỗi (missing trie node). Đổi RPC/ thử lại.'); return; }
          if (data === '0x' || msg.includes('without a reason string')){
            useLegacyOneArg = true;
          }else{
            try{
              if (typeof data === 'string' && data.length > 138){
                const str = ethers.utils.toUtf8String('0x' + data.slice(138));
                showError('❌ Contract từ chối: ' + str);
              }else{
                showError('❌ Contract từ chối yêu cầu.');
              }
            }catch{ showError('❌ Contract từ chối yêu cầu.'); }
            return;
          }
        }

        // Estimate & send
        if (btn){ btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ước lượng gas...'; }
        let tx;

        if (!useLegacyOneArg){
          let gas;
          try{
            gas = await contract.estimateGas.requestFullWithdrawal(campaignId, reason.trim());
          }catch(estErr){
            if ((estErr?.message||'').toLowerCase().includes('missing trie node')){ showError('❌ RPC node không đồng bộ.'); return; }
            // fallback sang 1-arg nếu estimateGas fail kiểu call-exception trống
            useLegacyOneArg = true;
          }

          if (!useLegacyOneArg){
            const gasLimit = gas.mul(12).div(10);
            if (btn){ btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gửi giao dịch...'; }
            tx = await contract.requestFullWithdrawal(campaignId, reason.trim(), { gasLimit });
          }
        }

        if (useLegacyOneArg){
          if (btn){ btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gửi (legacy ABI)...'; }
          const signer = web3.getSigner();
          const ifaceLegacy = new ethers.utils.Interface(['function requestFullWithdrawal(uint256 _campaignId)']);
          const data = ifaceLegacy.encodeFunctionData('requestFullWithdrawal', [campaignId]);
          let gasLimit = ethers.BigNumber.from('300000');
          try{
            const gas = await web3.estimateGas({ to: CONTRACT_CONFIG.CONTRACT_ADDRESS, from: userAccount, data });
            gasLimit = gas.mul(12).div(10);
          }catch(e){}
          tx = await signer.sendTransaction({ to: CONTRACT_CONFIG.CONTRACT_ADDRESS, data, gasLimit });
        }

        showSuccess('Đã gửi yêu cầu lên blockchain, chờ xác nhận...');
        const receipt = await tx.wait();
        if (receipt.status !== 1){ showError('❌ Giao dịch blockchain thất bại'); return; }

        // Lưu DB
        if (btn){ btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Lưu database...'; }
        const res = await fetch('/Campaigns/RequestFullWithdrawal', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
          },
          body: JSON.stringify({ campaignId, txHash: tx.hash, reason, address: userAccount })
        });

        if (res.ok){
          showSuccess('✅ Yêu cầu rút vốn đã ghi nhận!');
          closeWithdrawalModal();
          setTimeout(()=>window.location.reload(), 1500);
        }else{
          const e = await res.json().catch(()=>({}));
          showError('⚠️ Chain OK nhưng lưu DB lỗi: ' + (e.error||'Unknown'));
          closeWithdrawalModal();
          setTimeout(()=>window.location.reload(), 2000);
        }
      }catch(err){
        console.error('Withdrawal request error:', err);
        const msg = (err?.message||'').toLowerCase();
        if (msg.includes('missing trie node')) showError('❌ RPC node đang lỗi (missing trie node). Hãy đổi RPC/ thử lại.');
        else if (err.code === 4001 || err.code === 'ACTION_REJECTED') showError('❌ Bạn đã từ chối giao dịch');
        else if (msg.includes('insufficient funds')) showError('❌ Không đủ BNB để trả phí gas');
        else showError(err.reason || err.message || '❌ Lỗi không xác định khi yêu cầu rút vốn');
      }finally{
        if (btn){ btn.disabled = false; btn.innerHTML = originalText || '<i class="fas fa-paper-plane"></i> Gửi Yêu Cầu'; }
      }
    }

    /*********************** Execute/Update withdrawal ************************/
    async function checkWithdrawalExecution(campaignId) {
      const btn = event?.target;
      const originalText = btn?.innerHTML;
      try {
        if (!await ensureWalletConnected()) return;
        if (btn){ btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang kiểm tra...'; }

        // lấy requestId pending từ server
        let requestId = null;
        const apiRes = await fetch(`/api/campaigns/${campaignId}/pending-withdrawal`);
        if (!apiRes.ok) throw new Error((await apiRes.text()) || 'Server không trả về pending withdrawal.');
        const payload = await apiRes.json();
        if (Number.isFinite(Number(payload?.requestId))) requestId = Number(payload.requestId);
        else if (Number.isFinite(Number(payload?.requestIdOnChain))) requestId = Number(payload.requestIdOnChain);
        if (!Number.isFinite(requestId)) throw new Error('requestId không hợp lệ.');

        if (btn){ btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang thực thi on-chain...'; }
        const tx = await contract.checkAndExecuteWithdrawal(campaignId, requestId, { gasLimit: 300000 });
        showSuccess('Đang kiểm tra kết quả vote...');
        const receipt = await tx.wait();
        if (receipt.status !== 1) { showError('❌ Giao dịch blockchain thất bại!'); return; }

        // Cập nhật DB
        let wasApproved = false;
        try {
          const topic = ethers.utils.id("WithdrawalExecuted(uint8,uint256,uint256,address,uint256)");
          const log = receipt.logs.find(l => l.topics[0] === topic);
          if (log) {
            const decoded = contract.interface.decodeEventLog("WithdrawalExecuted", log.data, log.topics);
            wasApproved = (decoded.status === 1);
          }
        } catch (e) { console.warn('Parse logs failed:', e); }

        if (btn){ btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cập nhật database...'; }
        const resp = await fetch('/Campaigns/UpdateWithdrawalStatus', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
          },
          body: JSON.stringify({ campaignId, requestId, txHash: tx.hash, wasApproved })
        });

        if (resp.ok){
          const result = await resp.json().catch(()=>({}));
          if (wasApproved) showSuccess('✅ Yêu cầu rút vốn đã được phê duyệt & thực thi!');
          else {
            showSuccess('❌ Yêu cầu rút vốn bị từ chối' + (result?.rejectionCount!=null?` (bị từ chối ${result.rejectionCount} lần)`:'') );
            if ((result?.rejectionCount||0) >= 3) showError('⚠️ Chiến dịch có thể chuyển sang Failed do quá 3 lần bị từ chối.');
          }
        }else{
          const e = await resp.json().catch(()=>({}));
          showError('⚠️ Chain OK nhưng cập nhật DB lỗi: ' + (e.error || 'Unknown'));
        }
        setTimeout(()=>window.location.reload(), 2500);
      } catch (error) {
        console.error('Check withdrawal error:', error);
        showError(error.message || 'Có lỗi khi thực thi kiểm tra withdrawal.');
      } finally {
        if (btn){ btn.disabled = false; btn.innerHTML = originalText || '<i class="fas fa-check-circle"></i> Kiểm Tra Kết Quả Vote'; }
      }
    }

    /*********************** Profit flow ************************/
    function addProfitToCampaign(){ const m = document.getElementById('profitModal'); if (m) m.style.display = 'block'; }
    function closeProfitModal(){ const m = document.getElementById('profitModal'); if (m) m.style.display='none'; const f = document.getElementById('profitForm'); if (f) f.reset(); }

    async function submitProfitAddition(campaignId, amount){
      const btn = document.getElementById('submitProfit');
      const originalText = btn?.innerHTML;
      try{
        if (!await ensureWalletConnected()) return;
        const val = Number(amount);
        if (!val || val < 0.001){ showError('Nhập số tiền hợp lệ (tối thiểu 0.001 BNB)'); return; }
        if (btn){ btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang thêm...'; }

        const wei = ethers.utils.parseEther(val.toString());
        const tx = await contract.addProfit(campaignId, { value: wei, gasLimit: 250000 });
        showSuccess('Đang thêm lợi nhuận...');
        const receipt = await tx.wait();
        if (receipt.status !== 1){ showError('Giao dịch thất bại!'); return; }
        showSuccess('Thêm lợi nhuận thành công!');
        closeProfitModal();
        setTimeout(()=>window.location.reload(), 1600);
      }catch(err){
        console.error('Add profit error:', err);
        showError(err.message || 'Lỗi khi thêm lợi nhuận');
      }finally{
        if (btn){ btn.disabled = false; btn.innerHTML = originalText || '<i class="fas fa-plus"></i> Thêm Lợi Nhuận'; }
      }
    }

    /*********************** Other actions ************************/
    function investInCampaign(id){ window.location.href = `/Campaigns/Dashboard/${id}`; }
    function voteOnCampaign(id){ window.location.href = `/Campaigns/Dashboard/${id}`; }
    function claimProfits(id){ window.location.href = `/Campaigns/Dashboard/${id}`; }

    function claimRefund(id){
      if (confirm('Bạn có chắc chắn muốn claim lại tiền đầu tư không? Hành động này không thể hoàn tác.')) {
        claimRefundFromContract(id);
      }
    }

    async function claimRefundFromContract(campaignId){
      const btn = event?.target; const originalText = btn?.innerHTML;
      try{
        if (!await ensureWalletConnected()) return;
        if (btn){ btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...'; btn.disabled = true; }

        const tx = await contract.refund(campaignId, { gasLimit: 150000 });
        showSuccess('Đã gửi giao dịch claim refund...');
        const receipt = await tx.wait();
        if (receipt.status !== 1){ showError('Giao dịch thất bại!'); return; }
        showSuccess('Claim refund thành công!');

        const formData = new FormData();
        formData.append('CampaignId', campaignId);
        formData.append('TransactionHash', tx.hash);
        formData.append('InvestorAddress', userAccount || '');
        formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]')?.value || '');

        const response = await fetch('/Campaigns/ClaimRefund', { method:'POST', body: formData, credentials: 'same-origin' });
        if (!response.ok){
          const err = await response.json().catch(()=>({}));
          showError(err.error || 'Có lỗi khi cập nhật refund trên server.');
        }
        setTimeout(()=>window.location.reload(), 2200);
      }catch(error){
        console.error('Claim refund error:', error);
        showError(error.message || 'Có lỗi khi claim refund.');
      }finally{
        if (btn){ btn.disabled = false; btn.innerHTML = originalText || '<i class="fas fa-money-bill-wave"></i> Claim Lại Tiền'; }
      }
    }

    /*********************** MetaMask events ************************/
    async function bindWalletEvents(){
      if (typeof window.ethereum === 'undefined') return;
      window.ethereum.on('accountsChanged', async (accs)=>{
        if (!accs || accs.length===0){ showError('MetaMask đã ngắt kết nối'); userAccount=null; web3=null; contract=null; }
        else { await initializeWeb3(); }
      });
      window.ethereum.on('chainChanged', async (chainId)=>{
        const dec = parseInt(chainId,16);
        if (dec !== CONTRACT_CONFIG.EXPECTED_CHAIN_ID_DEC) showError('Vui lòng chuyển về BSC Testnet!');
        else await initializeWeb3();
      });
      window.ethereum.on('disconnect', ()=>{ showError('Kết nối MetaMask bị ngắt'); userAccount=null; web3=null; contract=null; });
    }

    /*********************** DOM Ready ************************/
    document.addEventListener('DOMContentLoaded', async ()=>{
      await initializeWeb3();
      await bindWalletEvents();

      // Gắn form Withdrawal
      const withdrawalForm = document.getElementById('withdrawalForm');
      if (withdrawalForm){
        withdrawalForm.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const reason = document.getElementById('withdrawalReason')?.value?.trim() || '';
          if (!reason){ showError('Vui lòng nhập lý do rút vốn!'); return; }
          await submitWithdrawalRequest(@Model.Id, reason);
        });
      }

      // Gắn form Profit
      const profitForm = document.getElementById('profitForm');
      if (profitForm){
        profitForm.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const amount = parseFloat(document.getElementById('profitAmount')?.value || '0');
          if (!amount || amount < 0.001){ showError('Vui lòng nhập số tiền hợp lệ (tối thiểu 0.001 BNB)!'); return; }
          await submitProfitAddition(@Model.Id, amount);
        });
      }

      // Click outside to close modals
      window.addEventListener('click', (evt)=>{
        const wm = document.getElementById('withdrawalModal');
        const pm = document.getElementById('profitModal');
        if (evt.target === wm) closeWithdrawalModal();
        if (evt.target === pm) closeProfitModal();
      });

      // Nhẹ: hiệu ứng xuất hiện
      const elements = document.querySelectorAll('.campaign-details-container > *');
      elements.forEach((el, i)=>{ el.style.animationDelay = `${i*0.1}s`; });

        // Load profit list if visible
        const profitHost = document.getElementById('profit-list');
        if (profitHost) {
          try { await loadProfitList(@Model.Id); } catch(e){ console.warn('loadProfitList failed:', e); }
        }
    });

      // Expose whether current user is investor to client-side JS
      const IS_INVESTOR = @(isInvestor ? "true" : "false");

      // Helper to return contract instance (ensure initializeWeb3 has set global `contract`)
    async function getContract(){ if (!contract) await ensureWalletConnected(); return contract; }

      async function addProfit(campaignId) {
        try {
          await ensureWalletConnected();
          const contract = await getContract();
          const input = document.getElementById('profit-amount');
          const amount = parseFloat(input.value);
          if (isNaN(amount) || amount <= 0) { showError('Nhập số tiền hợp lệ!'); return; }
          if (amount < 0.01) { showError('Tối thiểu 0.01 BNB!'); return; }
          const wei = ethers.utils.parseEther(amount.toString());
          const btn = document.getElementById('add-profit-btn');
          const t = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
          const tx = await contract.addProfit(campaignId, { value: wei, gasLimit: 200000 });
          showSuccess('Đã gửi giao dịch thêm lợi nhuận...');
          const r = await tx.wait();
          if (r.status === 1){ showSuccess(`Thêm lợi nhuận ${amount} BNB thành công!`); input.value=''; setTimeout(()=>loadProfitList(campaignId), 2000); }
          else showError('Giao dịch thất bại!');
          btn.disabled=false; btn.innerHTML = t;
        } catch (e) {
          console.error(e); showError(e.message || 'Có lỗi khi thêm lợi nhuận.');
          const btn = document.getElementById('add-profit-btn'); if (btn){ btn.disabled=false; btn.innerHTML='<i class="fas fa-plus"></i> Thêm lợi nhuận'; }
        }
      }

      async function loadProfitList(campaignId) {
        try {
          await ensureWalletConnected();
          const contract = await getContract();
          const host = document.getElementById('profit-list');
          if (!host) return;

          // Read number of profits from contract (assumes contract has profitCounter or profits mapping)
          let count = 0;
          try{ count = (await contract.profitCounter()).toNumber(); }catch(e){ /* fallback to server-rendered list */ }

          if (count > 0){
            // Build list by querying contract profits
            let html = '';
            for (let i = count-1; i >= 0; i--){
              try{
                const p = await contract.profits(i);
                const amount = ethers.utils.formatEther(p.amount || p[2] || 0);
                const ts = (p.createdAt && p.createdAt.toNumber) ? p.createdAt.toNumber() : parseInt((p.createdAt||0).toString(),10);
                const date = new Date(ts * 1000).toLocaleString();
                html += `
                  <div class="card" style="padding:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                      <div style="font-weight:800; color:var(--success);">${amount} BNB</div>
                      <small style="color:var(--muted)">${date}</small>
                    </div>
                    <div style="display:flex; gap:8px; align-items:center;">
                      ${ IS_INVESTOR ? `<button class=\"btn btn-success\" onclick=\"claimProfit(${campaignId}, ${i}, this)\"><i class=\"fas fa-money-bill-wave\"></i> Nhận lợi nhuận</button>` : '<span class="muted">Chỉ nhà đầu tư mới có thể nhận</span>' }
                    </div>
                  </div>`;
              }catch(e){ console.warn('read profit failed', e); }
            }
            host.innerHTML = html;
          } else {
            // No on-chain profits; keep server-rendered content
          }
        } catch (error) {
          console.error('Error loading profits:', error);
          const host = document.getElementById('profit-list'); if (host) host.innerHTML = '<p style="color:var(--danger);">Không thể tải danh sách lợi nhuận.</p>';
        }
      }

      async function claimProfit(campaignId, profitIndex, btnElem) {
        try{
          await ensureWalletConnected();
          const contract = await getContract();

          // Prefer the button element passed in via `this` from onclick. Fallback to a safer selector if not provided.
          let btn = btnElem;
          if (!btn) {
            // Look for an element whose onclick attribute contains the exact call including closing parenthesis
            const selector = `[onclick*="claimProfit(${campaignId}, ${profitIndex})"]`;
            btn = document.querySelector(selector);
          }

          const t = btn?.innerHTML || '';
          if (btn){ btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...'; }
          const tx = await contract.claimProfit(campaignId, profitIndex, { gasLimit: 200000 });
          showSuccess('Đã gửi giao dịch nhận lợi nhuận...');
          const r = await tx.wait();
          if (r.status === 1) { showSuccess('Nhận lợi nhuận thành công!'); setTimeout(()=>loadProfitList(campaignId), 2000); }
          else showError('Giao dịch thất bại!');
          if (btn){ btn.disabled=false; btn.innerHTML = t; }
        }catch(e){
          console.error(e); showError(e.message || 'Có lỗi khi nhận lợi nhuận.');
          // restore button on error
          let btn = btnElem;
          if (!btn) {
            const selector = `[onclick*="claimProfit(${campaignId}, ${profitIndex})"]`;
            btn = document.querySelector(selector);
          }
          if (btn){ btn.disabled=false; btn.innerHTML='<i class="fas fa-money-bill-wave"></i> Nhận lợi nhuận'; }
        }
      }
  </script>
}
