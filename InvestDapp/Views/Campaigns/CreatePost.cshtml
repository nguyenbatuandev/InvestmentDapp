@model InvestDapp.Shared.Common.Request.CreateCampaignPostRequest
@{
    ViewData["Title"] = "Tạo Bài Viết Chiến Dịch";
    Layout = "~/Pages/_Layout.cshtml";
    var campaign = ViewBag.Campaign as InvestDapp.Models.Campaign;
}

@section Styles {
    <style>
        /* Align CreatePost page to app layout variables */
        .post-wizard-container{ max-width:1000px; margin: calc(var(--header-h,72px) + 32px) auto 64px; padding:0 }

        .wizard-steps{ display:flex; align-items:center; justify-content:center; margin-bottom:22px; background:var(--glass); padding:16px; border-radius:var(--radius); border:1px solid var(--border); box-shadow:var(--shadow) }
        .step{ display:flex; align-items:center; gap:12px; color:var(--muted); font-weight:700 }
        .step.active{ color:var(--primary-2) }
        .step.completed{ color:var(--success) }
        .step-number{ min-width:40px; height:40px; border-radius:50%; background:var(--border); color:var(--muted); display:flex; align-items:center; justify-content:center; font-weight:800 }
        .step.active .step-number{ background:var(--primary-2); color:#04121b; box-shadow:0 8px 26px rgba(0,170,255,.08) }
        .step.completed .step-number{ background:var(--success); color:#04121b }
        .step-connector{ width:80px; height:2px; background:var(--border); margin:0 16px }

        .campaign-info-card{ background:var(--gradient); border-radius:var(--radius); padding:20px; margin-bottom:20px; color:var(--fg); box-shadow:0 8px 32px rgba(0,170,255,.06) }
        .campaign-info-card h3{ margin:0 0 8px; font-size:1.15rem }
        .campaign-meta{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:12px; margin-top:12px }
        .meta-item{ background:var(--card); padding:10px 12px; border-radius:10px; border:1px solid var(--border) }
        .meta-label{ font-size:.85rem; color:var(--muted); margin-bottom:4px }
        .meta-value{ font-weight:800; color:var(--primary-2) }

        .form-container{ background:var(--glass); border-radius:var(--radius); border:1px solid var(--border); overflow:hidden; box-shadow:var(--shadow) }
        .form-header{ background:var(--gradient); padding:20px 18px; text-align:left; color:var(--fg); display:flex; align-items:center; gap:12px }
        .form-header h2{ margin:0; font-size:1.25rem; font-weight:800 }
        .form-header p{ margin:0; color:var(--muted); font-size:.95rem }
        .form-body{ padding:20px 18px }

        .post-type-selector{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:12px; margin-bottom:18px }
        .post-type-option{ background:var(--card); border:2px solid var(--border); border-radius:12px; padding:16px; cursor:pointer; transition:all .2s ease; text-align:center; position:relative; overflow:hidden }
        .post-type-option::before{ content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background:linear-gradient(90deg, transparent, rgba(0,170,255,.08), transparent); transition:left .45s }
        .post-type-option:hover::before{ left:100% }
        .post-type-option:hover{ border-color:var(--primary-2); background:linear-gradient(90deg, rgba(0,170,255,.04), rgba(0,170,255,.02)); transform:translateY(-3px); box-shadow:0 6px 20px rgba(0,0,0,0.15) }
        .post-type-option.selected{ border-color:var(--primary-2); border-width:2px; background:linear-gradient(90deg, rgba(0,170,255,.06), rgba(0,170,255,.04)); transform:translateY(-3px); box-shadow:0 10px 30px rgba(0,170,255,0.15) }
        .post-type-option input[type="radio"]{ display:none }
        .post-type-icon{ font-size:2.2rem; margin-bottom:10px; color:var(--primary-2); transition:all .2s ease }
        .post-type-option:hover .post-type-icon, .post-type-option.selected .post-type-icon{ transform:scale(1.1) }
        .post-type-title{ font-weight:800; margin-bottom:8px; color:var(--fg); font-size:1.1rem }
        .post-type-desc{ font-size:.9rem; color:var(--muted) }

        .form-group{ margin-bottom:16px }
        .form-label{ display:block; margin-bottom:6px; font-weight:700; color:var(--fg); font-size:.92rem }
        .required{ color:var(--danger) }

        .form-control{ width:100%; padding:10px 12px; background:var(--card); border:1px solid var(--border); border-radius:10px; color:var(--fg); font-size:14px; transition:all .12s }
        .form-control:focus{ outline:none; border-color:var(--primary-2); box-shadow:0 8px 26px rgba(0,170,255,.06) }

    .editor-container{ border:1px solid var(--border); border-radius:10px; overflow:hidden; transition:all .2s ease; margin-bottom:8px; background:var(--card) }
    .editor-container:focus-within{ border-color:var(--primary-2); box-shadow:0 8px 26px rgba(0,170,255,.12) }
    .editor-placeholder{ background:var(--card); min-height:360px; padding:12px; color:var(--fg) }
        
        /* CKEditor specific styles for dark theme integration */
        .cke_chrome { border-color: transparent !important; box-shadow: none !important; background: var(--card) !important; }
        .cke_top { background: var(--card) !important; border-bottom: 1px solid var(--border) !important; }
        .cke_bottom { background: var(--card) !important; border-top: 1px solid var(--border) !important; }
        .cke_reset_all, .cke_reset_all * { color: var(--fg) !important; }
        .cke_combo_button, .cke_button { background: var(--card) !important; border-color: var(--border) !important; }
        .cke_combo_button:hover, .cke_button:hover { background: var(--bg-light) !important; border-color: var(--primary-2) !important; }
        .cke_button_on { background: var(--primary-2) !important; color: #04121b !important; }
        .cke_button_icon { filter: brightness(1.5) contrast(1.2); }
        .cke_dialog_body { background: var(--card) !important; border: 1px solid var(--border) !important; color: var(--fg) !important; }
        .cke_dialog_title { background: var(--gradient) !important; color: var(--fg) !important; }
        .cke_dialog_footer { background: var(--card) !important; }
        .cke_dialog_tab { background: var(--card) !important; color: var(--fg) !important; border-color: var(--border) !important; }
        .cke_dialog_tab_selected { background: var(--primary-2) !important; color: #04121b !important; }
        .cke_combo_text { color: var(--fg) !important; }
        .cke_combo_arrow { border-top-color: var(--fg) !important; }
        .cke_panel { background: var(--card) !important; border-color: var(--border) !important; }
        .cke_list a { color: var(--fg) !important; }
        .cke_list a:hover { background: var(--bg-light) !important; }

        .tags-input{ display:flex; flex-wrap:wrap; gap:8px; min-height:44px; padding:8px; background:var(--card); border:1px solid var(--border); border-radius:10px }
        .tag{ background:var(--primary-2); color:#04121b; padding:5px 10px; border-radius:20px; font-size:.85rem; display:flex; align-items:center; gap:6px }
        .tag-remove{ cursor:pointer; font-weight:800 }

        .checkbox-group{ display:flex; align-items:center; gap:10px; padding:10px; background:var(--card); border-radius:10px; border:1px solid var(--border); cursor:pointer }
        .checkbox-group:hover{ border-color:var(--primary-2) }
        .checkbox-group input[type="checkbox"]{ width:18px; height:18px; accent-color:var(--primary-2) }

        .form-actions{ background:transparent; padding:14px 18px; display:flex; justify-content:space-between; align-items:center }
        .btn-wizard{ padding:10px 16px; border-radius:10px; font-weight:800; display:inline-flex; align-items:center; gap:8px; text-decoration:none }
        .btn-primary-wizard{ background:var(--gradient); color:var(--fg); box-shadow:0 10px 30px rgba(0,170,255,.06) }
        .btn-primary-wizard:hover{ transform:translateY(-2px) }
        .btn-secondary-wizard{ background:var(--card); color:var(--fg); border:1px solid var(--border); padding:9px 14px }

        .alert{ padding:12px 14px; border-radius:10px; margin-bottom:12px; border-left:4px solid }
        .alert-danger{ background:rgba(255,107,107,.06); border-left-color:var(--danger); color:var(--danger) }
        .text-danger{ color:var(--danger); font-size:.85rem; margin-top:6px; display:none; align-items:center; gap:6px }
        .text-danger:not(:empty){ display:flex }

        @@media (max-width:768px){ .wizard-steps{ flex-direction:column; gap:12px } .step-connector{ width:2px;height:30px;margin:10px 0 } .post-type-selector{ grid-template-columns:1fr } .campaign-meta{ grid-template-columns:1fr } .form-body,.form-actions{ padding:14px } .form-actions{ flex-direction:column; gap:12px } .btn-wizard{ width:100%; justify-content:center } }

        /* animations */
        @@keyframes slideInUp{ from{ opacity:0; transform:translateY(12px) } to{ opacity:1; transform:none } }
    </style>
}

<div class="post-wizard-container">
    @{
        var hasExistingPosts = campaign?.Posts?.Any() ?? false;
        var isFirstPost = !hasExistingPosts;
        var isApproved = campaign?.ApprovalStatus == InvestDapp.Shared.Enums.ApprovalStatus.Approved;
    }

    @* Chỉ hiển thị progress steps cho bài viết đầu tiên *@
    @if (isFirstPost)
    {
        <!-- Progress Steps - Chỉ cho bài viết đầu tiên -->
        <div class="wizard-steps">
            <div class="step completed">
                <div class="step-number"><i class="fas fa-check"></i></div>
                <span>Tạo Chiến Dịch</span>
            </div>
            <div class="step-connector"></div>
            <div class="step active">
                <div class="step-number">2</div>
                <span>Tạo Bài Viết</span>
            </div>
            <div class="step-connector"></div>
            <div class="step">
                <div class="step-number">3</div>
                <span>Chờ Duyệt</span>
            </div>
        </div>
    }

    <!-- Campaign Info -->
    <div class="campaign-info-card">
        <h3><i class="fas fa-rocket"></i> Thông Tin Chiến Dịch</h3>
        <p><strong>@campaign?.Name</strong></p>
        <div class="campaign-meta">
            <div class="meta-item">
                <div class="meta-label">Trạng thái</div>
                <div class="meta-value">@campaign?.ApprovalStatus</div>
            </div>
            <div class="meta-item">
                <div class="meta-label">Mục tiêu</div>
                <div class="meta-value">@campaign?.GoalAmount BNB</div>
            </div>
            <div class="meta-item">
                <div class="meta-label">Ngày tạo</div>
                <div class="meta-value">@campaign?.CreatedAt.ToString("dd/MM/yyyy")</div>
            </div>
        </div>
    </div>

    <!-- Main Form -->
    <div class="form-container">
        <div class="form-header">
            <h2>
                <i class="fas fa-pen-fancy"></i>
                @if (isFirstPost)
                {
                    <text>Tạo Bài Viết Đầu Tiên</text>
                }
                else
                {
                    <text>Tạo Bài Viết Mới</text>
                }
            </h2>
            <p>
                @if (isFirstPost)
                {
                    <text>Viết bài giới thiệu cho chiến dịch của bạn. Bài viết này cần được admin phê duyệt!</text>
                }
                else
                {
                    <text>Viết bài cập nhật hoặc thông báo cho chiến dịch của bạn</text>
                }
            </p>
        </div>

        <form asp-action="CreatePost" method="post" id="postForm">
            @Html.AntiForgeryToken()
            <input asp-for="CampaignId" type="hidden" />

            <div class="form-body">
                @if (!ViewData.ModelState.IsValid)
                {
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Có lỗi xảy ra:</strong>
                        <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                            @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                            {
                                <li>@error.ErrorMessage</li>
                            }
                        </ul>
                    </div>
                }

                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-tag"></i> Loại Bài Viết <span class="required">*</span>
                    </label>
                    <div class="post-type-selector">
                        <label class="post-type-option">
                            <input asp-for="PostType" type="radio" value="0" />
                            <span class="post-type-icon">📝</span>
                            <div class="post-type-title">Giới Thiệu</div>
                            <div class="post-type-desc">Giới thiệu chi tiết về dự án</div>
                        </label>
                        <label class="post-type-option">
                            <input asp-for="PostType" type="radio" value="1" checked />
                            <span class="post-type-icon">🔄</span>
                            <div class="post-type-title">Cập Nhật</div>
                            <div class="post-type-desc">Cập nhật tiến độ dự án</div>
                        </label>
                        <label class="post-type-option">
                            <input asp-for="PostType" type="radio" value="2" />
                            <span class="post-type-icon">🏆</span>
                            <div class="post-type-title">Thành Tựu</div>
                            <div class="post-type-desc">Thành tựu đã đạt được</div>
                        </label>
                        <label class="post-type-option">
                            <input asp-for="PostType" type="radio" value="3" />
                            <span class="post-type-icon">📢</span>
                            <div class="post-type-title">Thông Báo</div>
                            <div class="post-type-desc">Thông báo quan trọng</div>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label asp-for="Title" class="form-label">
                        <i class="fas fa-heading"></i> Tiêu Đề <span class="required">*</span>
                    </label>
                    <input asp-for="Title" class="form-control" placeholder="VD: Chính thức Mở bán Công khai (IDO) Project Astra!" />
                    <span asp-validation-for="Title" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="Content" class="form-label">
                        <i class="fas fa-edit"></i> Nội Dung <span class="required">*</span>
                    </label>
                    <div class="editor-container">
                        <textarea asp-for="Content" id="tinymce-editor"></textarea>
                    </div>
                    <span asp-validation-for="Content" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="ImageUrl" class="form-label">
                        <i class="fas fa-image"></i> URL Hình Ảnh Đại Diện
                    </label>
                    <input asp-for="ImageUrl" type="url" class="form-control" placeholder="https://example.com/featured-image.jpg" />
                    <span asp-validation-for="ImageUrl" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="Tags" class="form-label">
                        <i class="fas fa-tags"></i> Tags (Phân cách bằng dấu phẩy)
                    </label>
                    <input asp-for="Tags" class="form-control" placeholder="blockchain, startup, technology, IDO, crypto" />
                    <span asp-validation-for="Tags" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label class="checkbox-group">
                        <input asp-for="IsFeatured" type="checkbox" />
                        <span>
                            <i class="fas fa-star"></i>
                            Đánh dấu là bài viết nổi bật
                            <small style="display: block; color: var(--text-muted); margin-top: 5px;">
                                Bài viết nổi bật sẽ được hiển thị ưu tiên trên trang chủ
                            </small>
                        </span>
                    </label>
                </div>
            </div>

            <div class="form-actions">
                <a href="@Url.Action("Details", new { id = campaign?.Id })" class="btn-wizard btn-secondary-wizard">
                    <i class="fas fa-arrow-left"></i> Quay Lại
                </a>
                <button type="submit" class="btn-wizard btn-primary-wizard" id="submitBtn">
                    <i class="fas fa-paper-plane"></i> Đăng Bài & Gửi Duyệt
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <!-- Nếu layout có CKEditor cũ, vô hiệu hóa để khỏi báo lỗi -->
    <script>
    (function() {
        if (window.CKEDITOR) {
            try {
                CKEDITOR.disableAutoInline = true;
                // Gỡ plugin gây lỗi nếu ai đó set global config
                CKEDITOR.config.extraPlugins = (CKEDITOR.config.extraPlugins || '')
                    .split(',')
                    .map(function(s){ return s.trim(); })
                    .filter(function(p){ return p && p !== 'image2' && p !== 'tableresize'; })
                    .join(',');
                // Hủy mọi instance nếu có
                for (var k in CKEDITOR.instances) {
                    if (CKEDITOR.instances[k]) CKEDITOR.instances[k].destroy(true);
                }
            } catch (e) { /* ignore */ }
        }
    })();
    </script>

    <!-- TinyMCE Editor -->
    <script src="https://cdn.jsdelivr.net/npm/tinymce@7.1.0/tinymce.min.js" referrerpolicy="origin"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        tinymce.init({
            selector: '#tinymce-editor',
            height: 500,
            language: 'en',
            menubar: 'file edit view insert format tools table help',
            plugins: [
                'advlist','autolink','lists','link','image','charmap','preview',
                'anchor','searchreplace','visualblocks','code','fullscreen',
                'insertdatetime','media','table','help','wordcount','emoticons',
                'codesample','pagebreak','nonbreaking'
            ],
            toolbar:
                'undo redo | styles | bold italic underline strikethrough | ' +
                'alignleft aligncenter alignright alignjustify | ' +
                'bullist numlist outdent indent | ' +
                'link image media table | forecolor backcolor | ' +
                'emoticons charmap | codesample | preview code | fullscreen help',

            skin: 'oxide-dark',
            content_css: 'dark',

            // CSS trong khung soạn thảo (có rule cho bảng)
            content_style: `
                body{font-family:Poppins,Arial,sans-serif;font-size:16px;line-height:1.6;background:#0a0e1a;color:#e0e0e0;margin:20px}
                h1,h2,h3,h4,h5,h6{color:#fff;margin:20px 0 10px}
                a{color:#00aaff}
                blockquote{border-left:4px solid #00aaff;margin:20px 0;padding-left:20px;color:#8a93b3;font-style:italic}
                code{background:#12182b;color:#00aaff;padding:2px 6px;border-radius:4px}
                pre{background:#12182b;border:1px solid #272c44;border-radius:8px;padding:15px;overflow-x:auto}
                table{border-collapse:collapse;width:100%;margin:12px 0}
                th,td{border:1px solid #2d3b55;padding:8px 10px;vertical-align:top}
                th{background:#162136;color:#e6e9ef;font-weight:700}
                tr:nth-child(even) td{background:rgba(255,255,255,.02)}
            `,

            // Khác
            branding: false,
            promotion: false,
            license_key: 'gpl',
            automatic_uploads: false,
            paste_data_images: true,
            verify_html: false,
            cleanup: true,
            convert_urls: false,

            // File picker ảnh (base64, đủ dùng dev)
            file_picker_callback: function (cb, value, meta) {
                if (meta.filetype === 'image') {
                    var input = document.createElement('input');
                    input.type = 'file'; input.accept = 'image/*';
                    input.onchange = function () {
                        var file = this.files[0], reader = new FileReader();
                        reader.onload = function () {
                            const id = 'blobid' + (new Date()).getTime();
                            const blobCache = tinymce.activeEditor.editorUpload.blobCache;
                            const base64 = reader.result.split(',')[1];
                            const blobInfo = blobCache.create(id, file, base64);
                            blobCache.add(blobInfo);
                            cb(blobInfo.blobUri(), { title: file.name });
                        };
                        reader.readAsDataURL(file);
                    };
                    input.click();
                }
            },

            setup: function (editor) {
                editor.on('init', function(){ console.log('TinyMCE ready'); });
                editor.on('change', function(){ editor.save(); });
            },

            // Placeholder
            placeholder: 'Viết nội dung bài viết tại đây...'
        });

        // Chọn loại bài viết (giữ nguyên UX)
        document.querySelectorAll('.post-type-option').forEach(function (opt) {
            opt.addEventListener('click', function () {
                document.querySelectorAll('.post-type-option').forEach(function (o){ o.classList.remove('selected'); });
                this.classList.add('selected');
                var radio = this.querySelector('input[type="radio"]'); if (radio) radio.checked = true;
            });
        });

        // Submit
        var form = document.getElementById('postForm');
        var submitBtn = document.getElementById('submitBtn');
        form.addEventListener('submit', function (e) {
            tinymce.triggerSave();
            var ed = tinymce.get('tinymce-editor');
            var content = ed ? ed.getContent() : '';
            if (!content.trim()) {
                e.preventDefault();
                alert('Vui lòng nhập nội dung bài viết!');
                return false;
            }
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang Đăng Bài...';
            submitBtn.disabled = true;
        });
    });
    </script>
}