@model IEnumerable<InvestDapp.Shared.Models.CampaignPost>
@{
    ViewData["Title"] = $"Bài Viết - {ViewBag.Campaign?.Name}";
    Layout = "~/Pages/_Layout.cshtml";
    var campaign = ViewBag.Campaign as InvestDapp.Models.Campaign;
}

@section Styles {
<style>
/* ===== POSTS LIST – KHỚP LAYOUT, KHÔNG DÙNG :root ===== */

.pl-page{max-width:1200px;margin:calc(var(--header-h,72px) + 28px) auto 64px;padding:0 16px;color:var(--fg)}
.pl-camp{
    background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
    padding:20px;box-shadow:var(--shadow);margin-bottom:22px
}
.pl-camp__row{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:16px}
.pl-camp__title{color:var(--primary);font-size:1.6rem;font-weight:900;margin:0 0 6px}
.pl-camp__meta{color:var(--muted);font-size:.95rem;font-weight:600;display:flex;gap:18px;flex-wrap:wrap}

.btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border-radius:12px;border:1px solid var(--border);
    background:var(--glass);color:var(--fg);text-decoration:none;font-weight:800;font-size:.92rem;transition:.2s ease;cursor:pointer}
.btn:hover{transform:translateY(-1px);border-color:var(--primary);color:var(--primary)}
.btn--primary{background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff;border-color:color-mix(in oklab,var(--primary) 45%, var(--border))}
.btn--primary:hover{transform:translateY(-1px);filter:saturate(1.02)}
.btn--warn{background:color-mix(in oklab,var(--warning, #ffb800) 18%, transparent);color:var(--warning,#ffb800);border-color:color-mix(in oklab,var(--warning,#ffb800) 40%, var(--border))}
.btn--danger{background:color-mix(in oklab,var(--danger,#ff6b6b) 16%, transparent);color:var(--danger,#ff6b6b);border-color:color-mix(in oklab,var(--danger,#ff6b6b) 40%, var(--border))}

/* List */
.pl-grid{display:grid;grid-template-columns:1fr;gap:16px}

/* Card */
.pl-card{
    background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
    overflow:hidden;box-shadow:var(--shadow);animation:plUp .5s ease
}
.pl-card:hover{transform:translateY(-2px);box-shadow:0 12px 32px rgba(0,0,0,.25)}

.pl-card__head{padding:18px;border-bottom:1px solid var(--border)}
.pl-title{font-size:1.25rem;font-weight:900;line-height:1.35;margin:0 0 10px;color:var(--fg)}
.pl-title a{color:inherit;text-decoration:none}
.pl-title a:hover{color:var(--primary)}

.pl-meta{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.pl-info{display:flex;align-items:center;gap:14px;color:var(--muted);font-weight:600;font-size:.95rem}

.badge{
    display:inline-flex;align-items:center;gap:8px;min-height:28px;padding:0 10px;border-radius:999px;font-size:.75rem;font-weight:800;
    border:1px solid var(--border);background:var(--glass);letter-spacing:.2px;line-height:1;color:var(--fg)
}

/* small circular dot to the left of the badge text; uses current text color for tint */
.badge::before{
    content:'';display:inline-block;width:12px;height:12px;border-radius:50%;background:currentColor;opacity:.16;flex:0 0 auto;margin-left:-2px;margin-right:6px;transform:translateY(-0px)
}

.badge--intro{color:#3498db;border-color:color-mix(in oklab,#3498db 40%, var(--border));background:color-mix(in oklab,#3498db 12%, transparent)}
.badge--update{color:#00d4aa;border-color:color-mix(in oklab,#00d4aa 40%, var(--border));background:color-mix(in oklab,#00d4aa 12%, transparent)}
.badge--achv{color:var(--warning,#ffb800);border-color:color-mix(in oklab,var(--warning,#ffb800) 40%, var(--border));background:color-mix(in oklab,var(--warning,#ffb800) 12%, transparent)}
.badge--anno{color:#9b59b6;border-color:color-mix(in oklab,#9b59b6 40%, var(--border));background:color-mix(in oklab,#9b59b6 12%, transparent)}

.chip{
    padding:6px 12px;border-radius:999px;font-size:.75rem;font-weight:900;display:inline-flex;align-items:center;gap:6px;
    border:1px solid
}
.chip--pending{color:var(--warning,#ffb800);border-color:color-mix(in oklab,var(--warning,#ffb800) 45%, var(--border));background:color-mix(in oklab,var(--warning,#ffb800) 14%, transparent)}
.chip--approved{color:var(--success,#16c79a);border-color:color-mix(in oklab,var(--success,#16c79a) 45%, var(--border));background:color-mix(in oklab,var(--success,#16c79a) 14%, transparent)}
.chip--rejected{color:var(--danger,#ff6b6b);border-color:color-mix(in oklab,var(--danger,#ff6b6b) 45%, var(--border));background:color-mix(in oklab,var(--danger,#ff6b6b) 14%, transparent)}

.pl-card__body{padding:18px;color:var(--muted);line-height:1.65}
.pl-excerpt{position:relative;max-height:96px;overflow:hidden}
.pl-excerpt:after{content:"";position:absolute;left:0;right:0;bottom:0;height:36px;background:linear-gradient(to bottom, rgba(0,0,0,0), var(--card))}

.pl-card__foot{
    padding:14px 18px;border-top:1px solid var(--border);background:var(--glass);
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap
}
.pl-stats{display:flex;align-items:center;gap:12px;color:var(--muted);font-size:.9rem;font-weight:700}

/* Empty */
.pl-empty{ text-align:center;padding:72px 16px;color:var(--muted);border:1px dashed var(--border);
    border-radius:var(--radius);background:var(--glass) }
.pl-empty__icon{font-size:3rem;margin-bottom:10px;opacity:.7}
.pl-empty__title{font-size:1.4rem;color:var(--fg);font-weight:900;margin:8px 0}

/* Responsive */
@@media (max-width:768px){
    .pl-camp__row{align-items:flex-start}
    .btn{width:100%;justify-content:center}
    .pl-meta{flex-direction:column;align-items:flex-start}
}

/* Animations */
@@keyframes plUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
</style>
}

<div class="pl-page">
    <!-- Campaign Header -->
    @if (campaign != null)
    {
        <section class="pl-camp">
            <div class="pl-camp__row">
                <div>
                    <h2 class="pl-camp__title">@campaign.Name</h2>
                    <div class="pl-camp__meta">
                        <span><i class="fas fa-calendar-alt"></i> Tạo lúc: @campaign.CreatedAt.ToString("dd/MM/yyyy")</span>
                        <span><i class="fas fa-eye"></i> @(Model?.Count() ?? 0) bài viết</span>
                    </div>
                </div>

                <div style="display:flex;gap:10px;flex-wrap:wrap">
                    <a href="@Url.Action("Details", new { id = campaign.Id })" class="btn">
                        <i class="fas fa-arrow-left"></i> Quay lại
                    </a>

                    @{
                        var currentUserWallet = User.FindFirst("WalletAddress")?.Value;
                        var isOwner = currentUserWallet == campaign.OwnerAddress;
                        var existingPosts = Model?.Any() ?? false;

                        var canCreatePost = false;
                        if (isOwner)
                        {
                            if (!existingPosts) { canCreatePost = true; }
                            else if (campaign.ApprovalStatus == InvestDapp.Shared.Enums.ApprovalStatus.Approved) { canCreatePost = true; }
                        }
                    }

                    @if (isOwner)
                    {
                        @if (canCreatePost)
                        {
                            <a href="@Url.Action("CreatePost", new { campaignId = campaign.Id })" class="btn btn--primary">
                                <i class="fas fa-plus"></i>
                                @( !existingPosts ? "Tạo Bài Viết Đầu Tiên" : "Tạo Bài Viết Mới")
                            </a>
                        }
                        else if (campaign.ApprovalStatus == InvestDapp.Shared.Enums.ApprovalStatus.Pending)
                        {
                            <span class="btn btn--warn" style="cursor:not-allowed">
                                <i class="fas fa-clock"></i> Chờ Admin duyệt chiến dịch
                            </span>
                        }
                    }
                </div>
            </div>
        </section>
    }

    @if (TempData["SuccessMessage"] != null)
    {
        <div style="background:color-mix(in oklab,var(--success,#16c79a) 12%, transparent);border:1px solid color-mix(in oklab,var(--success,#16c79a) 35%, var(--border));color:var(--success,#16c79a);padding:12px 16px;border-radius:12px;margin-bottom:16px;font-weight:700">
            <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div style="background:color-mix(in oklab,var(--danger,#ff6b6b) 12%, transparent);border:1px solid color-mix(in oklab,var(--danger,#ff6b6b) 35%, var(--border));color:var(--danger,#ff6b6b);padding:12px 16px;border-radius:12px;margin-bottom:16px;font-weight:700">
            <i class="fas fa-exclamation-triangle"></i> @TempData["ErrorMessage"]
        </div>
    }

    @if (Model?.Any() == true)
    {
        <!-- Posts Grid (giữ 1 cột như bố cục cũ) -->
        <section class="pl-grid">
            @foreach (var post in Model.OrderByDescending(p => p.CreatedAt))
            {
                <article class="pl-card">
                    <div class="pl-card__head">
                        <h3 class="pl-title">
                            <a href="@Url.Action("PostDetails", new { id = post.Id })">@post.Title</a>
                        </h3>

                        <div class="pl-meta">
                            <div class="pl-info">
                                @switch (post.PostType)
                                {
                                    case InvestDapp.Shared.Enums.PostType.Introduction:
                                        <span class="badge badge--intro">Giới thiệu</span>
                                        break;
                                    case InvestDapp.Shared.Enums.PostType.Update:
                                        <span class="badge badge--update">Cập nhật</span>
                                        break;
                                    case InvestDapp.Shared.Enums.PostType.Achievement:
                                        <span class="badge badge--achv">Thành tựu</span>
                                        break;
                                    case InvestDapp.Shared.Enums.PostType.Announcement:
                                        <span class="badge badge--anno">Thông báo</span>
                                        break;
                                }
                                <span><i class="fas fa-calendar-alt"></i> @post.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
                                <span><i class="fas fa-eye"></i> @post.ViewCount lượt xem</span>
                            </div>

                            @switch (post.ApprovalStatus)
                            {
                                case InvestDapp.Shared.Enums.ApprovalStatus.Pending:
                                    <span class="chip chip--pending"><i class="fas fa-clock"></i> Chờ duyệt</span>
                                    break;
                                case InvestDapp.Shared.Enums.ApprovalStatus.Approved:
                                    <span class="chip chip--approved"><i class="fas fa-check-circle"></i> Đã duyệt</span>
                                    break;
                                case InvestDapp.Shared.Enums.ApprovalStatus.Rejected:
                                    <span class="chip chip--rejected"><i class="fas fa-times-circle"></i> Bị từ chối</span>
                                    break;
                            }
                        </div>
                    </div>

                    <div class="pl-card__body">
                        <div class="pl-excerpt">
                            @Html.Raw(post.Content?.Substring(0, Math.Min(post.Content.Length, 200))?.Replace("\n", "<br/>"))
                        </div>
                    </div>

                    <div class="pl-card__foot">
                        <div class="pl-stats">
                            @if (!string.IsNullOrEmpty(post.Tags))
                            {
                                <span><i class="fas fa-tags"></i> @post.Tags</span>
                            }
                            @if (post.IsFeatured)
                            {
                                <span style="color:var(--warning,#ffb800)"><i class="fas fa-star"></i> Nổi bật</span>
                            }
                        </div>

                        <div style="display:flex;gap:10px;flex-wrap:wrap">
                            <a href="@Url.Action("PostDetails", new { id = post.Id })" class="btn" style="padding:10px 14px;font-size:.88rem">
                                <i class="fas fa-eye"></i> Xem chi tiết
                            </a>

                            @if (User.FindFirst("WalletAddress")?.Value == post.AuthorAddress)
                            {
                                <form method="post" action="@Url.Action("DeletePost", new { id = post.Id })" style="display:inline"
                                      onsubmit="return confirm('Bạn có chắc chắn muốn xóa bài viết này?');">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn--danger" style="padding:10px 14px;font-size:.88rem">
                                        <i class="fas fa-trash"></i> Xóa
                                    </button>
                                </form>
                            }
                        </div>
                    </div>
                </article>
            }
        </section>
    }
    else
    {
        <!-- Empty State -->
        <div class="pl-empty">
            <div class="pl-empty__icon"><i class="fas fa-newspaper"></i></div>
            <div class="pl-empty__title">Chưa có bài viết nào</div>
            <p style="margin:8px 0 18px">
                @if (campaign?.ApprovalStatus == InvestDapp.Shared.Enums.ApprovalStatus.Approved)
                {
                    <text>Chiến dịch này chưa có bài viết nào. Hãy tạo bài viết để chia sẻ thông tin với nhà đầu tư!</text>
                }
                else if (campaign?.ApprovalStatus == InvestDapp.Shared.Enums.ApprovalStatus.Pending)
                {
                    <text>Hãy tạo bài viết đầu tiên cho chiến dịch của bạn. Bài viết đầu tiên sẽ được tự động phê duyệt!</text>
                }
                else
                {
                    <text>Chiến dịch đã bị từ chối. Không thể tạo bài viết mới.</text>
                }
            </p>

            @if (User.FindFirst("WalletAddress")?.Value == campaign?.OwnerAddress &&
                (campaign?.ApprovalStatus == InvestDapp.Shared.Enums.ApprovalStatus.Approved ||
                 campaign?.ApprovalStatus == InvestDapp.Shared.Enums.ApprovalStatus.Pending))
            {
                <a href="@Url.Action("CreatePost", new { campaignId = campaign.Id })" class="btn btn--primary" style="padding:14px 22px">
                    <i class="fas fa-plus"></i>
                    @(campaign?.ApprovalStatus == InvestDapp.Shared.Enums.ApprovalStatus.Pending ? "Tạo Bài Viết Đầu Tiên" : "Tạo Bài Viết Mới")
                </a>
            }
        </div>
    }
</div>

@section Scripts {
<script>
document.addEventListener('DOMContentLoaded', function(){
    // Staggered animation
    const cards = document.querySelectorAll('.pl-card');
    cards.forEach((c,i)=> c.style.animationDelay = `${i*0.08}s`);
});
</script>
}
